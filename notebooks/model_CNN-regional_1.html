
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>&lt;no title&gt; &#8212; Storm Surge NZ - Summary</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.jpeg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Storm Surge NZ - Summary</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../README.html">
   geoocean-nz-ss
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Chapters
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="repo_workflow.html">
   1. Repository workflow + THEORY
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="useful_theory.html">
   2. Useful theory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_visualization.html">
   3. Data visualization and validation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="more_validations.html">
   4. LINZ and OTHER data analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="analysis_pca.html">
   5. PC analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models_linear.html">
   6. MultiLinear regression models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models_knn.html">
   7. KNN regression models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models_xgboost.html">
   8. XGBoost regression models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="experiments.html">
   9. RUN experiments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models_results.html">
   10. VISUALIZE experiments results
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/model_CNN-regional_1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/javitausia/geocean-nz-ss"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/javitausia/geocean-nz-ss/issues/new?title=Issue%20on%20page%20%2Fnotebooks/model_CNN-regional_1.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/javitausia/geocean-nz-ss/master?urlpath=tree/notebooks/model_CNN-regional_1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/javitausia/geocean-nz-ss/blob/master/notebooks/model_CNN-regional_1.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="simple visible nav section-nav flex-column">
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1><no title></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="simple visible nav section-nav flex-column">
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># basics</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>

<span class="c1"># arrays</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime</span><span class="p">,</span>
    <span class="n">timedelta</span>
<span class="p">)</span>

<span class="c1"># plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>

<span class="c1"># append sscode to path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;/home/metocean/geocean-nz-ss&#39;</span><span class="p">)</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;/data&#39;</span> <span class="c1">#&#39;/data/storm_surge_data/&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SSURGE_DATA_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_path</span>

<span class="c1"># custom</span>
<span class="kn">from</span> <span class="nn">sscode.config</span> <span class="kn">import</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">default_region_reduced</span><span class="p">,</span> <span class="n">default_evaluation_metrics</span><span class="p">,</span> <span class="n">default_region</span>
<span class="kn">from</span> <span class="nn">sscode.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">calculate_relative_winds</span><span class="p">,</span>
    <span class="n">spatial_gradient</span>
<span class="p">)</span>

<span class="c1"># warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># this is to allow plots to be centered</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;style&gt;</span>
<span class="s2">.output_png {</span>
<span class="s2">    display: table-cell;</span>
<span class="s2">    text-align: center;</span>
<span class="s2">    vertical-align: middle;</span>
<span class="s2">}</span>
<span class="s2">&lt;/style&gt;</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DATA PATH /data
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset attrs</span>
<span class="n">datasets_attrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;era5&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;ERA 5 reanalysis&#39;</span><span class="p">,</span><span class="s1">&#39;u10&#39;</span><span class="p">,</span><span class="s1">&#39;v10&#39;</span><span class="p">),</span>
    <span class="c1">#&#39;cfsr&#39;: (&#39;lon&#39;,&#39;lat&#39;,None,&#39;CFSR reanalysis&#39;,&#39;U_GRD_L103&#39;,&#39;V_GRD_L103&#39;),</span>
     <span class="s1">&#39;cfsr&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;CFSR reanalysis&#39;</span><span class="p">,</span><span class="s1">&#39;ugrd10m&#39;</span><span class="p">,</span><span class="s1">&#39;vgrd10m&#39;</span><span class="p">),</span>
    <span class="s1">&#39;dac&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;DAC global reanalysis&#39;</span><span class="p">),</span>
    <span class="s1">&#39;moana&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;site&#39;</span><span class="p">,</span><span class="s1">&#39;Moana v2 hindcast&#39;</span><span class="p">),</span>
    <span class="s1">&#39;codec&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;codec_coords_lon&#39;</span><span class="p">,</span><span class="s1">&#39;codec_coords_lat&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;CoDEC reanalysis&#39;</span><span class="p">),</span>
    <span class="s1">&#39;uhslc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;UHSLC tgs&#39;</span><span class="p">),</span>
    <span class="s1">&#39;linz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;LINZ tgs&#39;</span><span class="p">),</span>
    <span class="s1">&#39;other&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;OTHER tgs&#39;</span><span class="p">),</span>
    <span class="s1">&#39;privtgs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;Private tgs&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>First we load the storm surge data for mainland New Zealand only (excluding Chatham and Auckland Islands).
We will work  with the daily maxima. And to each time stamp, we associate the the maximum storm surge for the following 24 hours.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ss_dset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;storm_surge_data/moana_hindcast_v2/moana_coast.zarr/&#39;</span><span class="p">))</span>
<span class="n">ss_dset</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ss_dset</span><span class="o">.</span><span class="n">lat</span><span class="o">&gt;-</span><span class="mi">50</span><span class="p">,</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">lon</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">))</span>
<span class="n">predictand</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">ss</span>\
                    <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1994</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>\
                    <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>\
                    <span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>\
                    <span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_best_predictor_for_region</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">normalised</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">sscode.utils</span> <span class="kn">import</span> <span class="n">spatial_gradient</span>
    <span class="kn">from</span> <span class="nn">sscode.config</span> <span class="kn">import</span> <span class="n">default_region_reduced</span>
    
    <span class="n">pres_vars</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SLP&#39;</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span>
    <span class="n">wind_vars</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;wind_proj_mask&#39;</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="s1">&#39;U_GRD_L103&#39;</span><span class="p">,</span><span class="s1">&#39;V_GRD_L103&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">default_region_reduced</span>
    
    <span class="n">region_large</span> <span class="o">=</span> <span class="p">(</span> <span class="c1"># Pad to be able to do interpolation</span>
              <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading MSLP&quot;</span><span class="p">)</span>
    <span class="n">pres</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;cfsr&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;CFSR_MSLP_1H_1990_2021.nc&#39;</span><span class="p">))</span>\
             <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1994</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>\
             <span class="o">.</span><span class="n">sel</span><span class="p">({</span>
                    <span class="n">pres_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="nb">slice</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">pres_vars</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="nb">slice</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="p">})</span>\
             <span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading wind&quot;</span><span class="p">)</span>
    <span class="n">wind</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;cfsr&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;wnd10m/cfsr_wnd_1979_2021.nc&#39;</span><span class="p">))[[</span><span class="n">datasets_attrs</span><span class="p">[</span><span class="s1">&#39;cfsr&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span>
                                                                        <span class="n">datasets_attrs</span><span class="p">[</span><span class="s1">&#39;cfsr&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">]]]</span>\
              <span class="o">.</span><span class="n">rename</span><span class="p">({</span>
                 <span class="n">datasets_attrs</span><span class="p">[</span><span class="s1">&#39;cfsr&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]:</span> <span class="s1">&#39;u10m&#39;</span><span class="p">,</span>
                 <span class="n">datasets_attrs</span><span class="p">[</span><span class="s1">&#39;cfsr&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">]:</span> <span class="s1">&#39;v10m&#39;</span>
               <span class="p">})</span>\
              <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1994</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>\
              <span class="o">.</span><span class="n">sel</span><span class="p">({</span>
                 <span class="n">wind_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="nb">slice</span><span class="p">(</span><span class="n">region_large</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region_large</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                 <span class="n">wind_vars</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="nb">slice</span><span class="p">(</span><span class="n">region_large</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">region_large</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
               <span class="p">})</span>\
              <span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">datasets_attrs</span><span class="p">[</span><span class="s1">&#39;cfsr&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
              <span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">datasets_attrs</span><span class="p">[</span><span class="s1">&#39;cfsr&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
              <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>\
              <span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">wind_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">pres</span><span class="p">[</span><span class="n">pres_vars</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                              <span class="n">wind_vars</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">pres</span><span class="p">[</span><span class="n">pres_vars</span><span class="p">[</span><span class="mi">2</span><span class="p">]]})</span>\
              <span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">pres</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="c1"># interp to pressure coords </span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>        
    
    <span class="c1"># calculate the gradient                                                            </span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> calculating the gradient of the sea-level-pressure fields... </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">pres</span> <span class="o">=</span> <span class="n">spatial_gradient</span><span class="p">(</span><span class="n">pres</span><span class="p">,</span><span class="n">pres_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># from utils.py                      </span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> pressure/gradient predictor both with shape: </span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pres</span><span class="p">[</span><span class="n">pres_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="n">normalised</span><span class="p">:</span>
        <span class="n">all_predictors</span> <span class="o">=</span>\
           <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                      <span class="p">(</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                      <span class="p">(</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP_gradient</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP_gradient</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP_gradient</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">pres</span><span class="o">.</span><span class="n">SLP</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                      <span class="p">(</span><span class="n">wind</span><span class="o">.</span><span class="n">u10m</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">wind</span><span class="o">.</span><span class="n">u10m</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wind</span><span class="o">.</span><span class="n">u10m</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wind</span><span class="o">.</span><span class="n">u10m</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span>
                      <span class="p">(</span><span class="n">wind</span><span class="o">.</span><span class="n">v10m</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">wind</span><span class="o">.</span><span class="n">v10m</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">wind</span><span class="o">.</span><span class="n">v10m</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">wind</span><span class="o">.</span><span class="n">v10m</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>   
                     <span class="p">],</span>
                     <span class="s2">&quot;channel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_predictors</span> <span class="o">=</span> \
           <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                      <span class="n">pres</span><span class="o">.</span><span class="n">SLP</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                      <span class="n">pres</span><span class="o">.</span><span class="n">SLP_gradient</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                      <span class="n">wind</span><span class="o">.</span><span class="n">u10m</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                      <span class="n">wind</span><span class="o">.</span><span class="n">v10m</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
                     <span class="p">],</span>
                     <span class="s2">&quot;channel&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">all_predictors</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_predictors</span> <span class="o">=</span> <span class="n">get_best_predictor_for_region</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading MSLP
Done
Loading wind
Done

 calculating the gradient of the sea-level-pressure fields... 


 pressure/gradient predictor both with shape: 
 (195745, 45, 51) 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">all_predictors</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">channel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ss_dset</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">default_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">default_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">default_region</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">default_region</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-71.0, -19.0)
</pre></div>
</div>
<img alt="../_images/model_CNN-regional_1_6_1.png" src="../_images/model_CNN-regional_1_6_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow.compat.v2</span> <span class="k">as</span> <span class="nn">tfv2</span>
<span class="c1"># pylint: disable=g-classes-have-attributes</span>

<span class="c1"># These functions are adapted from</span>
<span class="c1"># https://github.com/keras-team/keras/blob/06ba37b8662dea768b3bc8201942f1eb877708e8/keras/preprocessing/timeseries.py</span>
<span class="c1"># The main addition is that they targets have been modified to contain both the input grid and the ss output</span>
<span class="c1"># That way it is possible to use the dataset to train both heads of the network</span>
    
<span class="k">def</span> <span class="nf">sequences_from_indices</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">indices_ds</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">):</span>
  <span class="n">dataset</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensors</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">start_index</span> <span class="p">:</span> <span class="n">end_index</span><span class="p">])</span>
  <span class="n">dataset</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">(),</span> <span class="n">indices_ds</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
      <span class="k">lambda</span> <span class="n">steps</span><span class="p">,</span> <span class="n">inds</span><span class="p">:</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">inds</span><span class="p">),</span>  <span class="c1"># pylint: disable=unnecessary-lambda</span>
      <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dataset</span>

<span class="k">def</span> <span class="nf">timeseries_dataset_from_array_seb</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">targets</span><span class="p">,</span>
    <span class="n">targets_2</span><span class="p">,</span>
    <span class="n">sequence_length</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sequence_stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">sampling_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">start_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">end_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates a dataset of sliding windows over a timeseries provided as array.</span>
<span class="sd">  This function takes in a sequence of data-points gathered at</span>
<span class="sd">  equal intervals, along with time series parameters such as</span>
<span class="sd">  length of the sequences/windows, spacing between two sequence/windows, etc.,</span>
<span class="sd">  to produce batches of timeseries inputs and targets.</span>
<span class="sd">  Args:</span>
<span class="sd">    data: Numpy array or eager tensor</span>
<span class="sd">      containing consecutive data points (timesteps).</span>
<span class="sd">      Axis 0 is expected to be the time dimension.</span>
<span class="sd">    targets: Targets corresponding to timesteps in `data`.</span>
<span class="sd">      `targets[i]` should be the target</span>
<span class="sd">      corresponding to the window that starts at index `i`</span>
<span class="sd">      (see example 2 below).</span>
<span class="sd">      Pass None if you don&#39;t have target data (in this case the dataset will</span>
<span class="sd">      only yield the input data).</span>
<span class="sd">    sequence_length: Length of the output sequences (in number of timesteps).</span>
<span class="sd">    sequence_stride: Period between successive output sequences.</span>
<span class="sd">      For stride `s`, output samples would</span>
<span class="sd">      start at index `data[i]`, `data[i + s]`, `data[i + 2 * s]`, etc.</span>
<span class="sd">    sampling_rate: Period between successive individual timesteps</span>
<span class="sd">      within sequences. For rate `r`, timesteps</span>
<span class="sd">      `data[i], data[i + r], ... data[i + sequence_length]`</span>
<span class="sd">      are used for create a sample sequence.</span>
<span class="sd">    batch_size: Number of timeseries samples in each batch</span>
<span class="sd">      (except maybe the last one).</span>
<span class="sd">    shuffle: Whether to shuffle output samples,</span>
<span class="sd">      or instead draw them in chronological order.</span>
<span class="sd">    seed: Optional int; random seed for shuffling.</span>
<span class="sd">    start_index: Optional int; data points earlier (exclusive)</span>
<span class="sd">      than `start_index` will not be used</span>
<span class="sd">      in the output sequences. This is useful to reserve part of the</span>
<span class="sd">      data for test or validation.</span>
<span class="sd">    end_index: Optional int; data points later (exclusive) than `end_index`</span>
<span class="sd">      will not be used in the output sequences.</span>
<span class="sd">      This is useful to reserve part of the data for test or validation.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A tfv2.data.Dataset instance. If `targets` was passed, the dataset yields</span>
<span class="sd">    tuple `(batch_of_sequences, batch_of_targets)`. If not, the dataset yields</span>
<span class="sd">    only `batch_of_sequences`.</span>
<span class="sd">  Example 1:</span>
<span class="sd">  Consider indices `[0, 1, ... 99]`.</span>
<span class="sd">  With `sequence_length=10,  sampling_rate=2, sequence_stride=3`,</span>
<span class="sd">  `shuffle=False`, the dataset will yield batches of sequences</span>
<span class="sd">  composed of the following indices:</span>
<span class="sd">  ```</span>
<span class="sd">  First sequence:  [0  2  4  6  8 10 12 14 16 18]</span>
<span class="sd">  Second sequence: [3  5  7  9 11 13 15 17 19 21]</span>
<span class="sd">  Third sequence:  [6  8 10 12 14 16 18 20 22 24]</span>
<span class="sd">  ...</span>
<span class="sd">  Last sequence:   [78 80 82 84 86 88 90 92 94 96]</span>
<span class="sd">  ```</span>
<span class="sd">  In this case the last 3 data points are discarded since no full sequence</span>
<span class="sd">  can be generated to include them (the next sequence would have started</span>
<span class="sd">  at index 81, and thus its last step would have gone over 99).</span>
<span class="sd">  Example 2: Temporal regression.</span>
<span class="sd">  Consider an array `data` of scalar values, of shape `(steps,)`.</span>
<span class="sd">  To generate a dataset that uses the past 10</span>
<span class="sd">  timesteps to predict the next timestep, you would use:</span>
<span class="sd">  ```python</span>
<span class="sd">  input_data = data[:-10]</span>
<span class="sd">  targets = data[10:]</span>
<span class="sd">  dataset = tfv2.keras.preprocessing.timeseries_dataset_from_array(</span>
<span class="sd">      input_data, targets, sequence_length=10)</span>
<span class="sd">  for batch in dataset:</span>
<span class="sd">    inputs, targets = batch</span>
<span class="sd">    assert np.array_equal(inputs[0], data[:10])  # First sequence: steps [0-9]</span>
<span class="sd">    assert np.array_equal(targets[0], data[10])  # Corresponding target: step 10</span>
<span class="sd">    break</span>
<span class="sd">  ```</span>
<span class="sd">  Example 3: Temporal regression for many-to-many architectures.</span>
<span class="sd">  Consider two arrays of scalar values `X` and `Y`,</span>
<span class="sd">  both of shape `(100,)`. The resulting dataset should consist samples with</span>
<span class="sd">  20 timestamps each. The samples should not overlap.</span>
<span class="sd">  To generate a dataset that uses the current timestamp</span>
<span class="sd">  to predict the corresponding target timestep, you would use:</span>
<span class="sd">  ```python</span>
<span class="sd">  X = np.arange(100)</span>
<span class="sd">  Y = X*2</span>
<span class="sd">  sample_length = 20</span>
<span class="sd">  input_dataset = tfv2.keras.preprocessing.timeseries_dataset_from_array(</span>
<span class="sd">    X, None, sequence_length=sample_length, sequence_stride=sample_length)</span>
<span class="sd">  target_dataset = tfv2.keras.preprocessing.timeseries_dataset_from_array(</span>
<span class="sd">    Y, None, sequence_length=sample_length, sequence_stride=sample_length)</span>
<span class="sd">  for batch in zip(input_dataset, target_dataset):</span>
<span class="sd">    inputs, targets = batch</span>
<span class="sd">    assert np.array_equal(inputs[0], X[:sample_length])</span>
<span class="sd">    # second sample equals output timestamps 20-40</span>
<span class="sd">    assert np.array_equal(targets[1], Y[sample_length:2*sample_length])</span>
<span class="sd">    break</span>
<span class="sd">  ```</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">start_index</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">start_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`start_index` must be 0 or greater. Received: &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;start_index=</span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`start_index` must be lower than the length of the &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;data. Received: start_index=</span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s1">, for data &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">end_index</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">start_index</span> <span class="ow">and</span> <span class="n">end_index</span> <span class="o">&lt;=</span> <span class="n">start_index</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`end_index` must be higher than `start_index`. &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;Received: start_index=</span><span class="si">{</span><span class="n">start_index</span><span class="si">}</span><span class="s1">, and &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;end_index=</span><span class="si">{</span><span class="n">end_index</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`end_index` must be lower than the length of the &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;data. Received: end_index=</span><span class="si">{</span><span class="n">end_index</span><span class="si">}</span><span class="s1">, for data of &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end_index</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`end_index` must be higher than 0. &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;Received: end_index=</span><span class="si">{</span><span class="n">end_index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

  <span class="c1"># Validate strides</span>
  <span class="k">if</span> <span class="n">sampling_rate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`sampling_rate` must be higher than 0. Received: &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;sampling_rate=</span><span class="si">{</span><span class="n">sampling_rate</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">sampling_rate</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`sampling_rate` must be lower than the length of the &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;data. Received: sampling_rate=</span><span class="si">{</span><span class="n">sampling_rate</span><span class="si">}</span><span class="s1">, for data &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">sequence_stride</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`sequence_stride` must be higher than 0. Received: &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;sequence_stride=</span><span class="si">{</span><span class="n">sequence_stride</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">sequence_stride</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`sequence_stride` must be lower than the length of the &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;data. Received: sequence_stride=</span><span class="si">{</span><span class="n">sequence_stride</span><span class="si">}</span><span class="s1">, for &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;data of length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">start_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="n">end_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">end_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

  <span class="c1"># Determine the lowest dtype to store start positions (to lower memory usage).</span>
  <span class="n">num_seqs</span> <span class="o">=</span> <span class="n">end_index</span> <span class="o">-</span> <span class="n">start_index</span> <span class="o">-</span> <span class="p">(</span><span class="n">sequence_length</span> <span class="o">*</span> <span class="n">sampling_rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">num_seqs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_seqs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">num_seqs</span> <span class="o">&lt;</span> <span class="mi">2147483647</span><span class="p">:</span>
    <span class="n">index_dtype</span> <span class="o">=</span> <span class="s1">&#39;int32&#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">index_dtype</span> <span class="o">=</span> <span class="s1">&#39;int64&#39;</span>

  <span class="c1"># Generate start positions</span>
  <span class="n">start_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_seqs</span><span class="p">,</span> <span class="n">sequence_stride</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mf">1e6</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">start_positions</span><span class="p">)</span>

  <span class="n">sequence_length</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">sequence_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
  <span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>

  <span class="n">positions_ds</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensors</span><span class="p">(</span><span class="n">start_positions</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span>

  <span class="c1"># For each initial window position, generates indices of the window elements</span>
  <span class="n">indices</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span>
      <span class="p">(</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_positions</span><span class="p">)),</span> <span class="n">positions_ds</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
          <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">range</span><span class="p">(</span>  <span class="c1"># pylint: disable=g-long-lambda</span>
              <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
              <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sequence_length</span> <span class="o">*</span> <span class="n">sampling_rate</span><span class="p">,</span>
              <span class="n">sampling_rate</span><span class="p">),</span>
          <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

  <span class="n">dataset</span> <span class="o">=</span> <span class="n">sequences_from_indices</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">)</span>
  <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">targets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span>
        <span class="p">(</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_positions</span><span class="p">)),</span> <span class="n">positions_ds</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="n">target_ds</span> <span class="o">=</span> <span class="n">sequences_from_indices</span><span class="p">(</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">targets_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_ds_2</span> <span class="o">=</span> <span class="n">sequences_from_indices</span><span class="p">(</span>
            <span class="n">targets_2</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">target_ds</span><span class="p">,</span> <span class="n">target_ds_2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
    <span class="c1">#outputs.append((target_ds, dataset))</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_ds</span><span class="p">)</span>
    <span class="c1">##dataset = tfv2.data.Dataset.zip((dataset, (target_ds, dataset)))</span>
    
    <span class="c1">#outputs.append((target_ds, dataset))</span>
    <span class="c1">#outputs.append(target_ds)</span>

  <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span>
        <span class="p">(</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_positions</span><span class="p">)),</span> <span class="n">positions_ds</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="n">target_weights_dset</span> <span class="o">=</span> <span class="n">sequences_from_indices</span><span class="p">(</span>
            <span class="n">weights</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">)</span>
    
    <span class="n">indices</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span>
      <span class="p">(</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_positions</span><span class="p">)),</span> <span class="n">positions_ds</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
          <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">range</span><span class="p">(</span>  <span class="c1"># pylint: disable=g-long-lambda</span>
              <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
              <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sequence_length</span> <span class="o">*</span> <span class="n">sampling_rate</span><span class="p">,</span>
              <span class="n">sampling_rate</span><span class="p">),</span>
          <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

    <span class="n">ae_weights_dset</span> <span class="o">=</span> <span class="n">sequences_from_indices</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">,)),</span> <span class="n">indices</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span><span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">target_weights_dset</span><span class="p">,</span> <span class="n">ae_weights_dset</span><span class="p">))</span>
    <span class="c1">#dataset = tfv2.data.Dataset.zip((dataset, (target_ds, dataset)))</span>
  <span class="n">dataset</span> <span class="o">=</span> <span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
    <span class="c1"># Shuffle locally at each iteration</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
  <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">tfv2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dataset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="n">to_use</span><span class="o">=</span><span class="mi">0</span>

<span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_visible_devices</span><span class="p">(</span><span class="n">gpus</span><span class="p">[</span><span class="n">to_use</span><span class="p">],</span> <span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
    <span class="n">logical_gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">list_logical_devices</span><span class="p">(</span><span class="s1">&#39;GPU&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpus</span><span class="p">),</span> <span class="s2">&quot;Physical GPUs,&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logical_gpus</span><span class="p">),</span> <span class="s2">&quot;Logical GPU&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Visible devices must be set before GPUs have been initialized</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># Invalid device or cannot modify virtual devices once initialized.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to select GPU&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2 Physical GPUs, 1 Logical GPU
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-12-16 02:02:14.540113: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.541269: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.547531: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.548346: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.548701: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.549501: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.550514: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2021-12-16 02:02:14.551328: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.552058: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.552797: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.909266: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.909870: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.910422: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:937] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero
2021-12-16 02:02:14.910947: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1510] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 22315 MB memory:  -&gt; device: 0, name: GeForce RTX 3090, pci bus id: 0000:01:00.0, compute capability: 8.6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_training_and_validation_sets</span><span class="p">(</span><span class="n">predictors</span><span class="p">,</span>
                                     <span class="n">predictand</span><span class="p">,</span>
                                     <span class="n">input_sequence_length</span><span class="p">,</span>
                                     <span class="n">input_sequence_frequency</span><span class="p">,</span>
                                     <span class="n">lead_time</span><span class="p">,</span>
                                     <span class="n">target_sequence_frequency</span><span class="p">,</span>
                                     <span class="n">fold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                     <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                                     <span class="n">print_test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="p">(</span> <span class="ow">not</span> <span class="p">(</span><span class="n">predictand</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">predictand</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span>\
        <span class="p">(</span><span class="n">predictand</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">predictand</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time spacing is not constant in predictand dataset&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    
    <span class="k">if</span> <span class="p">(</span> <span class="ow">not</span> <span class="p">(</span><span class="n">predictors</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">predictors</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span>\
        <span class="p">(</span><span class="n">predictors</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">predictors</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time spacing is not constant in predictor dataset&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    
    <span class="c1"># Find start, end and extent of dataset</span>
    <span class="p">[</span><span class="n">tstart_predictor</span><span class="p">,</span> <span class="n">tend_predictor</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="p">[</span><span class="n">tstart_predictand</span><span class="p">,</span> <span class="n">tend_predictand</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[s]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tstart_predictand</span><span class="p">,</span> <span class="n">tstart_predictor</span><span class="p">)</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tend_predictand</span><span class="p">,</span> <span class="n">tend_predictor</span><span class="p">)</span>
    <span class="n">time_extent</span> <span class="o">=</span> <span class="n">tend</span> <span class="o">-</span> <span class="n">tstart</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Returning fold &quot;</span><span class="p">,</span><span class="n">fold</span><span class="p">,</span><span class="s2">&quot; of &quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="p">,</span> <span class="s2">&quot; e.g. </span><span class="si">%2.1f</span><span class="s2"> percent training data&quot;</span><span class="o">%</span><span class="p">((</span><span class="n">n_folds</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">n_folds</span><span class="o">*</span><span class="mf">100.</span><span class="p">))</span>

    <span class="c1"># Finding time bounds of training data segments</span>
    <span class="n">tstart_1</span> <span class="o">=</span> <span class="n">tstart</span>
    <span class="n">tend_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tstart</span> <span class="o">+</span> <span class="n">time_extent</span><span class="o">*</span><span class="p">((</span><span class="n">n_folds</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">fold</span><span class="p">)</span><span class="o">/</span><span class="n">n_folds</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">tstart_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tstart</span> <span class="o">+</span> <span class="n">time_extent</span><span class="o">*</span><span class="p">((</span><span class="n">n_folds</span><span class="o">-</span><span class="n">fold</span><span class="p">)</span><span class="o">/</span><span class="n">n_folds</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tend_2</span> <span class="o">=</span> <span class="n">tend</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="n">train_dset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tstart_train</span><span class="p">,</span> <span class="n">tend_train</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">tstart_1</span><span class="p">,</span> <span class="n">tstart_2</span><span class="p">],[</span><span class="n">tend_1</span><span class="p">,</span> <span class="n">tend_2</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">tstart_train</span> <span class="o">!=</span> <span class="n">tend_train</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding&quot;</span><span class="p">,</span> <span class="n">tstart_train</span><span class="p">,</span> <span class="n">tend_train</span><span class="p">,</span><span class="s2">&quot;to training dataset&quot;</span><span class="p">)</span>

            <span class="n">predictor_train</span> <span class="o">=</span>\
                <span class="n">predictors</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">tstart_train</span><span class="p">,</span>
                                          <span class="n">tend_train</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="p">(</span><span class="n">lead_time</span><span class="o">-</span><span class="n">target_sequence_frequency</span><span class="p">))))</span>\
                          <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">input_sequence_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>\
                          <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="p">(</span><span class="n">input_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>\
                          <span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">input_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>\
                          <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">ss_train</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">tstart_train</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">input_sequence_length</span><span class="o">+</span><span class="n">lead_time</span><span class="o">-</span><span class="n">target_sequence_frequency</span><span class="p">),</span>
                                      <span class="n">tend_train</span><span class="p">))</span>\
                                 <span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>\
                                 <span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>\
                                 <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">target_sequence_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>\
                                 <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="p">(</span><span class="n">target_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>\
                                 <span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">target_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="mi">100</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss_train</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ss_train</span> <span class="o">=</span> <span class="n">ss_train</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">print_test</span><span class="p">:</span> <span class="c1"># To check indices are fine</span>
                <span class="n">test_dset</span> <span class="o">=</span> <span class="n">timeseries_dataset_from_array_seb</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">predictor_train</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">-</span><span class="mi">786412800000000000</span><span class="p">)</span><span class="o">//</span><span class="mi">3600000000000</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">ss_train</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">-</span><span class="mi">786412800000000000</span><span class="p">)</span><span class="o">//</span><span class="mi">3600000000000</span><span class="p">,</span>
                    <span class="n">targets_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">sequence_length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),</span>
                    <span class="n">sequence_stride</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">target_sequence_frequency</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),</span>
                    <span class="n">sampling_rate</span><span class="o">=</span><span class="n">input_sequence_frequency</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_index</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)</span>
        
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All integer correspond to number of hours with respect to reference date&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">test_dset</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span>
                    <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Times in:&quot;</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="s2">&quot;Times out:&quot;</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
                    <span class="n">print_test</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">train_dset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeseries_dataset_from_array_seb</span><span class="p">(</span>
                    <span class="n">predictor_train</span><span class="p">,</span>
                    <span class="n">ss_train</span><span class="p">,</span>
                    <span class="n">targets_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sequence_length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),</span>
                <span class="n">sequence_stride</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">target_sequence_frequency</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),</span>
                <span class="n">sampling_rate</span><span class="o">=</span><span class="n">input_sequence_frequency</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_index</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">))</span>
            
    <span class="c1"># If multiple segments concatenate them into a single dataset</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">train_dset</span> <span class="o">=</span> <span class="n">train_dset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">train_dset</span> <span class="o">=</span> <span class="n">train_dset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">train_dset</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


    <span class="c1"># Validation data</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding&quot;</span><span class="p">,</span> <span class="n">tend_1</span><span class="p">,</span> <span class="n">tstart_2</span><span class="p">,</span><span class="s2">&quot;to validation dataset&quot;</span><span class="p">)</span>
    <span class="n">predictor_val</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">tend_1</span><span class="p">,</span>
                                              <span class="n">tstart_2</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="p">(</span><span class="n">lead_time</span><span class="o">-</span><span class="n">target_sequence_frequency</span><span class="p">))))</span>\
                              <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">input_sequence_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>\
                              <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="p">(</span><span class="n">input_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>\
                              <span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">input_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>\
                              <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ss_val</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">tend_1</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">input_sequence_length</span><span class="o">+</span><span class="n">lead_time</span><span class="o">-</span><span class="n">target_sequence_frequency</span><span class="p">),</span>
                                       <span class="n">tstart_2</span><span class="p">))</span>\
                       <span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>\
                       <span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>\
                       <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">target_sequence_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>\
                       <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">time</span><span class="o">=-</span><span class="p">(</span><span class="n">target_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>\
                       <span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">target_sequence_frequency</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="mi">100</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss_val</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ss_val</span> <span class="o">=</span> <span class="n">ss_val</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


    <span class="n">val_dset</span> <span class="o">=</span> <span class="n">timeseries_dataset_from_array_seb</span><span class="p">(</span>
        <span class="n">predictor_val</span><span class="p">,</span>
        <span class="n">ss_val</span><span class="p">,</span>
        <span class="n">targets_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),</span>
        <span class="n">sequence_stride</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">target_sequence_frequency</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),</span>
        <span class="n">sampling_rate</span><span class="o">=</span><span class="n">input_sequence_frequency</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_index</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">train_dset</span><span class="p">,</span> <span class="n">val_dset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Conv2D</span><span class="p">,</span>
    <span class="n">Conv3D</span><span class="p">,</span>
    <span class="n">BatchNormalization</span><span class="p">,</span>
    <span class="n">MaxPool2D</span><span class="p">,</span>
    <span class="n">MaxPool3D</span><span class="p">,</span>
    <span class="n">ConvLSTM2D</span><span class="p">,</span>
    <span class="n">GlobalMaxPool2D</span><span class="p">,</span>
    <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span>
    <span class="n">TimeDistributed</span><span class="p">,</span>
    <span class="n">GRU</span><span class="p">,</span>
    <span class="n">Dense</span><span class="p">,</span>
    <span class="n">Dropout</span><span class="p">,</span>
    <span class="n">Conv1D</span><span class="p">,</span>
    <span class="n">LSTM</span><span class="p">,</span>
    <span class="n">Conv2DTranspose</span><span class="p">,</span>
    <span class="n">Reshape</span><span class="p">,</span>
    <span class="n">Cropping2D</span><span class="p">,</span>
    <span class="n">Cropping1D</span><span class="p">,</span>
    <span class="n">Activation</span><span class="p">,</span>
    <span class="n">Lambda</span><span class="p">,</span>
    <span class="n">Concatenate</span><span class="p">,</span>
    <span class="n">TimeDistributed</span><span class="p">,</span>
    <span class="n">Flatten</span><span class="p">,</span>
    <span class="n">Reshape</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.backend</span> <span class="kn">import</span> <span class="nb">sum</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="c1">#4*32</span>

<span class="n">input_sequence_length</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mi">24</span> <span class="c1"># In hours</span>
<span class="n">input_sequence_frequency</span><span class="o">=</span><span class="mi">24</span> <span class="c1"># In hours</span>
<span class="n">lead_time</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># In hours</span>
<span class="n">target_sequence_frequency</span><span class="o">=</span><span class="mi">24</span> <span class="c1"># In hours</span>

<span class="n">dset_train</span><span class="p">,</span> <span class="n">dset_val</span> <span class="o">=</span> <span class="n">get_training_and_validation_sets</span><span class="p">(</span><span class="n">predictors</span><span class="o">=</span><span class="n">all_predictors</span><span class="p">,</span>
                                                        <span class="n">predictand</span><span class="o">=</span><span class="n">predictand</span><span class="p">,</span>
                                                        <span class="n">input_sequence_length</span><span class="o">=</span><span class="n">input_sequence_length</span><span class="p">,</span>
                                                        <span class="n">input_sequence_frequency</span><span class="o">=</span><span class="n">input_sequence_frequency</span><span class="p">,</span>
                                                        <span class="n">lead_time</span><span class="o">=</span><span class="n">lead_time</span><span class="p">,</span>
                                                        <span class="n">target_sequence_frequency</span><span class="o">=</span><span class="n">target_sequence_frequency</span><span class="p">,</span>
                                                        <span class="n">fold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                                                        <span class="n">print_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returning fold  0  of  5  e.g. 80.0 percent training data

Adding 1994-12-01 00:00:00 2012-08-26 10:00:00 to training dataset
SS dimensions (155412, 1358)
&lt;class &#39;numpy.ndarray&#39;&gt;
All integer correspond to number of hours with respect to reference date
Times in: tf.Tensor([117977 118001 118025], shape=(3,), dtype=int64) Times out: tf.Tensor(118025, shape=(), dtype=int64)
Times in: tf.Tensor([139301 139325 139349], shape=(3,), dtype=int64) Times out: tf.Tensor(139349, shape=(), dtype=int64)
Times in: tf.Tensor([108241 108265 108289], shape=(3,), dtype=int64) Times out: tf.Tensor(108289, shape=(), dtype=int64)
Times in: tf.Tensor([89853 89877 89901], shape=(3,), dtype=int64) Times out: tf.Tensor(89901, shape=(), dtype=int64)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-12-16 02:03:19.346356: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:185] None of the MLIR Optimization Passes are enabled (registered 2)
2021-12-16 02:03:19.433537: W tensorflow/core/framework/cpu_allocator_impl.cc:80] Allocation of 11418744960 exceeds 10% of free system memory.
2021-12-16 02:03:24.136817: W tensorflow/core/framework/cpu_allocator_impl.cc:80] Allocation of 11418744960 exceeds 10% of free system memory.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;xarray.core.dataarray.DataArray&#39;&gt;
Adding 2012-08-26 10:00:00 2017-02-01 01:00:00 to validation dataset
&lt;class &#39;xarray.core.dataarray.DataArray&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_fancy_model_regional</span><span class="p">(</span><span class="n">shape_in</span><span class="p">,</span>
                               <span class="n">nbout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape_in</span><span class="p">)</span>
    
    <span class="n">conv_1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">conv_2</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))(</span><span class="n">conv_1</span><span class="p">)</span>
    <span class="n">conv_3</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))(</span><span class="n">conv_2</span><span class="p">)</span>
    
    <span class="n">cnn_outputs</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">conv_3</span><span class="p">,</span> <span class="n">inputs</span><span class="p">])</span>
    
    <span class="n">cnn_outputs</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))(</span><span class="n">cnn_outputs</span><span class="p">)</span>
    
    <span class="n">pool_1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">GlobalMaxPool2D</span><span class="p">())(</span><span class="n">cnn_outputs</span><span class="p">)</span>
    
    <span class="n">sum_1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cnn_outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sum_2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cnn_outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">conv_pool_1</span> <span class="o">=</span> <span class="n">Conv1D</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))(</span><span class="n">pool_1</span><span class="p">)</span>
    
    
    <span class="n">conv_sum_1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))(</span><span class="n">sum_1</span><span class="p">)</span>
    <span class="n">conv_sum_2</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))(</span><span class="n">sum_2</span><span class="p">)</span>
    
    <span class="n">conv_pool_1</span> <span class="o">=</span> <span class="n">Reshape</span><span class="p">(</span><span class="n">conv_pool_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span><span class="o">+</span><span class="n">conv_pool_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])(</span><span class="n">conv_pool_1</span><span class="p">)</span>
    
    <span class="n">concat_2</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)([</span><span class="n">conv_sum_1</span><span class="p">,</span> <span class="n">conv_sum_2</span><span class="p">,</span> <span class="n">conv_pool_1</span><span class="p">])</span>
        
    <span class="n">flat</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()(</span><span class="n">concat_2</span><span class="p">)</span>

    <span class="n">dense_1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="c1">#48,</span>
                    <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                    <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span>
                    <span class="p">)(</span><span class="n">flat</span><span class="p">)</span>
    
    <span class="n">dropout_1</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nbout</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">dropout_1</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape_in</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),)</span> <span class="o">+</span> <span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">fancy_model_cnn_regional</span> <span class="o">=</span> <span class="n">build_fancy_model_cnn</span><span class="p">(</span><span class="n">shape_in</span><span class="o">=</span><span class="n">shape_in</span><span class="p">,</span>
                                                 <span class="n">nbout</span><span class="o">=</span><span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(None, 3, 45, 51, 24) (None, 3, 45, 51, 4)
SS (None, 1, 49, 24) (None, 1, 43, 24) (None, 1, 1, 24)
Model: &quot;model&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_1 (InputLayer)            [(None, 3, 45, 51, 4 0                                            
__________________________________________________________________________________________________
time_distributed (TimeDistribut (None, 3, 45, 51, 6) 222         input_1[0][0]                    
__________________________________________________________________________________________________
time_distributed_1 (TimeDistrib (None, 3, 45, 51, 12 660         time_distributed[0][0]           
__________________________________________________________________________________________________
time_distributed_2 (TimeDistrib (None, 3, 45, 51, 24 2616        time_distributed_1[0][0]         
__________________________________________________________________________________________________
concatenate (Concatenate)       (None, 3, 45, 51, 28 0           time_distributed_2[0][0]         
                                                                 input_1[0][0]                    
__________________________________________________________________________________________________
time_distributed_3 (TimeDistrib (None, 3, 45, 51, 24 696         concatenate[0][0]                
__________________________________________________________________________________________________
time_distributed_4 (TimeDistrib (None, 3, 24)        0           time_distributed_3[0][0]         
__________________________________________________________________________________________________
tf.math.reduce_sum (TFOpLambda) (None, 3, 51, 24)    0           time_distributed_3[0][0]         
__________________________________________________________________________________________________
tf.math.reduce_sum_1 (TFOpLambd (None, 3, 45, 24)    0           time_distributed_3[0][0]         
__________________________________________________________________________________________________
conv1d (Conv1D)                 (None, 1, 24)        1752        time_distributed_4[0][0]         
__________________________________________________________________________________________________
conv2d_4 (Conv2D)               (None, 1, 49, 24)    5208        tf.math.reduce_sum[0][0]         
__________________________________________________________________________________________________
conv2d_5 (Conv2D)               (None, 1, 43, 24)    5208        tf.math.reduce_sum_1[0][0]       
__________________________________________________________________________________________________
reshape (Reshape)               (None, 1, 1, 24)     0           conv1d[0][0]                     
__________________________________________________________________________________________________
concatenate_1 (Concatenate)     (None, 1, 93, 24)    0           conv2d_4[0][0]                   
                                                                 conv2d_5[0][0]                   
                                                                 reshape[0][0]                    
__________________________________________________________________________________________________
flatten (Flatten)               (None, 2232)         0           concatenate_1[0][0]              
__________________________________________________________________________________________________
dense (Dense)                   (None, 48)           107184      flatten[0][0]                    
__________________________________________________________________________________________________
dropout (Dropout)               (None, 48)           0           dense[0][0]                      
__________________________________________________________________________________________________
dense_1 (Dense)                 (None, 1358)         66542       dropout[0][0]                    
==================================================================================================
Total params: 190,088
Trainable params: 190,088
Non-trainable params: 0
__________________________________________________________________________________________________
None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">)</span>
<span class="n">fancy_model_cnn_regional</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">fancy_model_cnn_regional</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dset_train</span><span class="p">,</span>
                                       <span class="n">validation_data</span><span class="o">=</span><span class="n">dset_val</span><span class="p">,</span>
                                       <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/20
4857/4857 [==============================] - 40s 8ms/step - loss: 21.1458 - mse: 21.0840 - mae: 3.5348 - val_loss: 19.5196 - val_mse: 19.4579 - val_mae: 3.4157
Epoch 2/20
4857/4857 [==============================] - 40s 8ms/step - loss: 21.1332 - mse: 21.0714 - mae: 3.5319 - val_loss: 19.4913 - val_mse: 19.4294 - val_mae: 3.4094
Epoch 3/20
4857/4857 [==============================] - 40s 8ms/step - loss: 21.0958 - mse: 21.0339 - mae: 3.5296 - val_loss: 19.5013 - val_mse: 19.4394 - val_mae: 3.4105
Epoch 4/20
4857/4857 [==============================] - 40s 8ms/step - loss: 21.0493 - mse: 20.9873 - mae: 3.5260 - val_loss: 19.5677 - val_mse: 19.5057 - val_mae: 3.4219
Epoch 5/20
4857/4857 [==============================] - 40s 8ms/step - loss: 21.0256 - mse: 20.9635 - mae: 3.5249 - val_loss: 19.3838 - val_mse: 19.3217 - val_mae: 3.4010
Epoch 6/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.9621 - mse: 20.8999 - mae: 3.5192 - val_loss: 19.4528 - val_mse: 19.3906 - val_mae: 3.4100
Epoch 7/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.9796 - mse: 20.9173 - mae: 3.5204 - val_loss: 19.4574 - val_mse: 19.3951 - val_mae: 3.4088
Epoch 8/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.9561 - mse: 20.8937 - mae: 3.5191 - val_loss: 19.3509 - val_mse: 19.2885 - val_mae: 3.3971
Epoch 9/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.8997 - mse: 20.8373 - mae: 3.5146 - val_loss: 19.4168 - val_mse: 19.3543 - val_mae: 3.4054
Epoch 10/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.8619 - mse: 20.7993 - mae: 3.5100 - val_loss: 19.3448 - val_mse: 19.2822 - val_mae: 3.3977
Epoch 11/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.8252 - mse: 20.7625 - mae: 3.5076 - val_loss: 19.4308 - val_mse: 19.3681 - val_mae: 3.4073
Epoch 12/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.8260 - mse: 20.7633 - mae: 3.5074 - val_loss: 19.3763 - val_mse: 19.3135 - val_mae: 3.3986
Epoch 13/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.8127 - mse: 20.7498 - mae: 3.5073 - val_loss: 19.3872 - val_mse: 19.3243 - val_mae: 3.4007
Epoch 14/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.7505 - mse: 20.6876 - mae: 3.5033 - val_loss: 19.4544 - val_mse: 19.3914 - val_mae: 3.4050
Epoch 15/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.7434 - mse: 20.6804 - mae: 3.5011 - val_loss: 19.4162 - val_mse: 19.3531 - val_mae: 3.4039
Epoch 16/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.7236 - mse: 20.6605 - mae: 3.4993 - val_loss: 19.4408 - val_mse: 19.3776 - val_mae: 3.4076
Epoch 17/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.6784 - mse: 20.6152 - mae: 3.4962 - val_loss: 19.4307 - val_mse: 19.3674 - val_mae: 3.4038
Epoch 18/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.6716 - mse: 20.6083 - mae: 3.4956 - val_loss: 19.3694 - val_mse: 19.3060 - val_mae: 3.4005
Epoch 19/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.6863 - mse: 20.6230 - mae: 3.4961 - val_loss: 19.4047 - val_mse: 19.3413 - val_mae: 3.4009
Epoch 20/20
4857/4857 [==============================] - 40s 8ms/step - loss: 20.6508 - mse: 20.5873 - mae: 3.4932 - val_loss: 19.4964 - val_mse: 19.4329 - val_mae: 3.4064
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fcc06c43370&gt;
</pre></div>
</div>
<img alt="../_images/model_CNN-regional_1_16_1.png" src="../_images/model_CNN-regional_1_16_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">50</span><span class="o">/</span><span class="mi">50</span>
<span class="mi">4857</span><span class="o">/</span><span class="mi">4857</span> <span class="p">[</span><span class="o">==============================</span><span class="p">]</span> <span class="o">-</span> <span class="mi">40</span><span class="n">s</span> <span class="mi">8</span><span class="n">ms</span><span class="o">/</span><span class="n">step</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">19.0807</span> <span class="o">-</span> <span class="n">mse</span><span class="p">:</span> <span class="mf">19.0098</span> <span class="o">-</span> <span class="n">mae</span><span class="p">:</span> <span class="mf">3.4077</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">19.7701</span> <span class="o">-</span> <span class="n">val_mse</span><span class="p">:</span> <span class="mf">19.6991</span> <span class="o">-</span> <span class="n">val_mae</span><span class="p">:</span> <span class="mf">3.6104</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_val_fancy_cnn_regional</span> <span class="o">=</span> <span class="n">fancy_model_cnn_regional</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dset_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calculate_stats</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dset_val</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">prediction_val_fancy_cnn_regional</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>bias -0.0042181625
si 0.4896816
rmse 0.0510613
rmse_95 0.072939664
rmse_99 0.0956224
pearson 0.850560123474346
pearson_95 0.6053344550186868
pearson_99 0.7074245647638671
rscore 0.720418211374733
rscore_95 -1.4325456443485574
rscore_99 -9.002199847049408
nse [0.72041821]
nse_95 [-1.43254564]
nse_99 [-9.00219985]
kge [0.73942824]
ext_kge_95 [0.53588204]
ext_kge_99 [0.33013048]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_coast_stats</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">prediction</span><span class="p">):</span>
    <span class="n">truth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dset</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">prediction</span>
    
    
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">prediction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">title</span><span class="p">,</span> <span class="n">point_stats</span> <span class="o">=</span> <span class="n">generate_stats</span><span class="p">(</span><span class="n">truth</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span>
                                            <span class="n">prediction</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span>
                                            <span class="n">metrics</span><span class="o">=</span><span class="n">default_evaluation_metrics</span><span class="p">,</span>
                                            <span class="n">ext_quantile</span><span class="o">=</span><span class="n">default_ext_quantile</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point_stats</span><span class="p">)</span>
        
    <span class="n">all_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">all_stats</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">all_stats</span>

<span class="n">stats_val</span> <span class="o">=</span> <span class="n">calculate_coast_stats</span><span class="p">(</span><span class="n">dset_val</span><span class="p">,</span> <span class="n">prediction_val_fancy_cnn_regional</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">linear_results</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;/home/metocean/geocean-nz-ss/data/statistics/experiments/experiment_linear_final_20211113.nc&#39;</span><span class="p">)</span>
<span class="n">best_linear_results</span> <span class="o">=</span> <span class="n">linear_results</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">winds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tlapse</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s1">&#39;local_2.5_2.5&#39;</span><span class="p">,</span> <span class="n">tresample</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>
<span class="n">best_linear_results</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;kgeprime&#39;</span><span class="p">]</span>

<span class="n">sites_linear</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">lons_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">sites_nn</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span>
<span class="n">lons_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    
    <span class="n">vals_linear</span> <span class="o">=</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals_nn</span> <span class="o">=</span> <span class="n">stats_val</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    
    <span class="n">vals_diff</span> <span class="o">=</span> <span class="n">vals_linear</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stats_val</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sites_nn</span><span class="o">==</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_linear</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    
    <span class="n">vdiff_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals_diff</span><span class="p">))</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_linear</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_nn</span><span class="p">,</span> <span class="n">lats_nn</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_nn</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                         <span class="n">c</span><span class="o">=</span><span class="n">vals_diff</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vdiff_max</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vdiff_max</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model minus CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites_linear</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">lons_linear</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lats_linear</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/model_CNN-regional_1_21_0.png" src="../_images/model_CNN-regional_1_21_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">site_id</span> <span class="o">=</span> <span class="mi">393</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span><span class="n">site_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dset_val</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20000</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prediction_val_fancy_cnn_regional</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span><span class="n">site_id</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span><span class="n">site_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dset_val</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">20000</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prediction_val_fancy_cnn_regional</span><span class="p">[</span><span class="mi">20000</span><span class="p">:,</span><span class="n">site_id</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No handles with labels found to put in legend.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fcc06f8e400&gt;
</pre></div>
</div>
<img alt="../_images/model_CNN-regional_1_22_2.png" src="../_images/model_CNN-regional_1_22_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">site_id</span> <span class="o">=</span> <span class="mi">708</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span><span class="n">site_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dset_val</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20000</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prediction_val_fancy_cnn_regional</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20000</span><span class="p">,</span><span class="n">site_id</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:,</span><span class="n">site_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dset_val</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">20000</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prediction_val_fancy_cnn_regional</span><span class="p">[</span><span class="mi">20000</span><span class="p">:,</span><span class="n">site_id</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>No handles with labels found to put in legend.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fcc0c1b5790&gt;
</pre></div>
</div>
<img alt="../_images/model_CNN-regional_1_23_2.png" src="../_images/model_CNN-regional_1_23_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">linear_results</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;/home/metocean/geocean-nz-ss/data/statistics/experiments/linear_superfinal.nc&#39;</span><span class="p">)</span>
<span class="n">best_linear_results</span> <span class="o">=</span> <span class="n">linear_results</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="c1">#.sel(grad=True, winds=True, tlapse=3, region=&#39;local_2.5_2.5&#39;, tresample=&#39;1D&#39;)</span>
<span class="n">best_linear_results</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;kgeprime&#39;</span><span class="p">]</span>

<span class="n">sites_linear</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">lons_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">sites_nn</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span>
<span class="n">lons_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    
    <span class="n">vals_linear</span> <span class="o">=</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals_nn</span> <span class="o">=</span> <span class="n">stats_val</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    
    <span class="n">vals_diff</span> <span class="o">=</span> <span class="n">vals_linear</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stats_val</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sites_nn</span><span class="o">==</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_linear</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    
    <span class="n">vdiff_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals_diff</span><span class="p">))</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_linear</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_nn</span><span class="p">,</span> <span class="n">lats_nn</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_nn</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                         <span class="n">c</span><span class="o">=</span><span class="n">vals_diff</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vdiff_max</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vdiff_max</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model minus CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/model_CNN-regional_1_25_0.png" src="../_images/model_CNN-regional_1_25_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">ReLU</span><span class="p">,</span> <span class="n">BatchNormalization</span><span class="p">,</span>\
                                    <span class="n">Add</span><span class="p">,</span> <span class="n">AveragePooling2D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">GlobalMaxPooling3D</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="k">def</span> <span class="nf">relu_bn</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="n">relu</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">bn</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">relu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bn</span>

<span class="k">def</span> <span class="nf">first_block</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
               <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
               <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">relu_bn</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">residual_block</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">downsample</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
               <span class="n">strides</span><span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">downsample</span> <span class="k">else</span> <span class="mi">2</span><span class="p">),</span>
               <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
               <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">relu_bn</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
               <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
               <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">downsample</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                   <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
                   <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">relu_bn</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_resnet_model</span><span class="p">(</span><span class="n">shape_in</span><span class="p">,</span>
                       <span class="n">nbout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">cnn_filters</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
                       <span class="n">dense</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">]):</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">shape_in</span><span class="p">)</span>
    
    <span class="n">end_block_1</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="k">for</span> <span class="n">n_filter</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">]:</span> <span class="c1"># [8, 16, 32]</span>
        <span class="n">conv_1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filter</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))(</span><span class="n">end_block_1</span><span class="p">)</span>
        <span class="n">bn_1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())(</span><span class="n">conv_1</span><span class="p">)</span>
        <span class="n">conv_2</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filter</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))(</span><span class="n">bn_1</span><span class="p">)</span>
    
        <span class="n">res_1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">n_filter</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))(</span><span class="n">end_block_1</span><span class="p">)</span>
    
        <span class="n">add_1</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)([</span><span class="n">conv_2</span><span class="p">,</span> <span class="n">res_1</span><span class="p">])</span>
        <span class="n">end_bn_1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">ReLU</span><span class="p">())(</span><span class="n">add_1</span><span class="p">)</span>
        <span class="n">end_block_1</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">BatchNormalization</span><span class="p">())(</span><span class="n">end_bn_1</span><span class="p">)</span>
    
    
    <span class="n">conv3d</span> <span class="o">=</span> <span class="n">Conv3D</span><span class="p">(</span><span class="n">n_filter</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))(</span><span class="n">end_block_1</span><span class="p">)</span>
    
        
    <span class="n">flat</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()(</span><span class="n">conv3d</span><span class="p">)</span>

    <span class="n">dropout_1</span> <span class="o">=</span> <span class="n">flat</span>
    <span class="k">for</span> <span class="n">n_dense</span> <span class="ow">in</span> <span class="n">dense</span><span class="p">:</span>
        <span class="n">dense_1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">n_dense</span><span class="p">,</span> <span class="c1">#48,</span>
                        <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                        <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span>
                        <span class="p">)(</span><span class="n">dropout_1</span><span class="p">)</span>
        <span class="n">dropout_1</span> <span class="o">=</span> <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>
    
    <span class="n">out</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">nbout</span><span class="p">,</span>
                <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">dropout_1</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape_in</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),)</span> <span class="o">+</span> <span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">model_resnet</span> <span class="o">=</span> <span class="n">build_resnet_model</span><span class="p">(</span><span class="n">shape_in</span><span class="o">=</span><span class="n">shape_in</span><span class="p">,</span>
                                                 <span class="n">nbout</span><span class="o">=</span><span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_6&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_28 (InputLayer)           [(None, 3, 45, 51, 4 0                                            
__________________________________________________________________________________________________
time_distributed_116 (TimeDistr (None, 3, 23, 26, 8) 296         input_28[0][0]                   
__________________________________________________________________________________________________
time_distributed_117 (TimeDistr (None, 3, 23, 26, 8) 32          time_distributed_116[0][0]       
__________________________________________________________________________________________________
time_distributed_118 (TimeDistr (None, 3, 23, 26, 8) 584         time_distributed_117[0][0]       
__________________________________________________________________________________________________
time_distributed_119 (TimeDistr (None, 3, 23, 26, 8) 40          input_28[0][0]                   
__________________________________________________________________________________________________
concatenate_20 (Concatenate)    (None, 3, 23, 26, 16 0           time_distributed_118[0][0]       
                                                                 time_distributed_119[0][0]       
__________________________________________________________________________________________________
time_distributed_120 (TimeDistr (None, 3, 23, 26, 16 0           concatenate_20[0][0]             
__________________________________________________________________________________________________
time_distributed_121 (TimeDistr (None, 3, 23, 26, 16 64          time_distributed_120[0][0]       
__________________________________________________________________________________________________
time_distributed_122 (TimeDistr (None, 3, 12, 13, 12 1740        time_distributed_121[0][0]       
__________________________________________________________________________________________________
time_distributed_123 (TimeDistr (None, 3, 12, 13, 12 48          time_distributed_122[0][0]       
__________________________________________________________________________________________________
time_distributed_124 (TimeDistr (None, 3, 12, 13, 12 1308        time_distributed_123[0][0]       
__________________________________________________________________________________________________
time_distributed_125 (TimeDistr (None, 3, 12, 13, 12 204         time_distributed_121[0][0]       
__________________________________________________________________________________________________
concatenate_21 (Concatenate)    (None, 3, 12, 13, 24 0           time_distributed_124[0][0]       
                                                                 time_distributed_125[0][0]       
__________________________________________________________________________________________________
time_distributed_126 (TimeDistr (None, 3, 12, 13, 24 0           concatenate_21[0][0]             
__________________________________________________________________________________________________
time_distributed_127 (TimeDistr (None, 3, 12, 13, 24 96          time_distributed_126[0][0]       
__________________________________________________________________________________________________
time_distributed_128 (TimeDistr (None, 3, 6, 7, 24)  5208        time_distributed_127[0][0]       
__________________________________________________________________________________________________
time_distributed_129 (TimeDistr (None, 3, 6, 7, 24)  96          time_distributed_128[0][0]       
__________________________________________________________________________________________________
time_distributed_130 (TimeDistr (None, 3, 6, 7, 24)  5208        time_distributed_129[0][0]       
__________________________________________________________________________________________________
time_distributed_131 (TimeDistr (None, 3, 6, 7, 24)  600         time_distributed_127[0][0]       
__________________________________________________________________________________________________
concatenate_22 (Concatenate)    (None, 3, 6, 7, 48)  0           time_distributed_130[0][0]       
                                                                 time_distributed_131[0][0]       
__________________________________________________________________________________________________
time_distributed_132 (TimeDistr (None, 3, 6, 7, 48)  0           concatenate_22[0][0]             
__________________________________________________________________________________________________
time_distributed_133 (TimeDistr (None, 3, 6, 7, 48)  192         time_distributed_132[0][0]       
__________________________________________________________________________________________________
conv3d_5 (Conv3D)               (None, 1, 6, 7, 24)  3480        time_distributed_133[0][0]       
__________________________________________________________________________________________________
flatten_6 (Flatten)             (None, 1008)         0           conv3d_5[0][0]                   
__________________________________________________________________________________________________
dense_12 (Dense)                (None, 50)           50450       flatten_6[0][0]                  
__________________________________________________________________________________________________
dropout_6 (Dropout)             (None, 50)           0           dense_12[0][0]                   
__________________________________________________________________________________________________
dense_13 (Dense)                (None, 1358)         69258       dropout_6[0][0]                  
==================================================================================================
Total params: 138,904
Trainable params: 138,640
Non-trainable params: 264
__________________________________________________________________________________________________
None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape_in</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),)</span> <span class="o">+</span> <span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">model_resnet</span> <span class="o">=</span> <span class="n">build_resnet_model</span><span class="p">(</span><span class="n">shape_in</span><span class="o">=</span><span class="n">shape_in</span><span class="p">,</span>
                                                 <span class="n">nbout</span><span class="o">=</span><span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_3&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_21 (InputLayer)           [(None, 3, 45, 51, 4 0                                            
__________________________________________________________________________________________________
time_distributed_42 (TimeDistri (None, 3, 23, 26, 8) 296         input_21[0][0]                   
__________________________________________________________________________________________________
time_distributed_43 (TimeDistri (None, 3, 23, 26, 8) 32          time_distributed_42[0][0]        
__________________________________________________________________________________________________
time_distributed_44 (TimeDistri (None, 3, 23, 26, 8) 584         time_distributed_43[0][0]        
__________________________________________________________________________________________________
time_distributed_45 (TimeDistri (None, 3, 23, 26, 8) 40          input_21[0][0]                   
__________________________________________________________________________________________________
concatenate_8 (Concatenate)     (None, 3, 23, 26, 16 0           time_distributed_44[0][0]        
                                                                 time_distributed_45[0][0]        
__________________________________________________________________________________________________
time_distributed_46 (TimeDistri (None, 3, 23, 26, 16 0           concatenate_8[0][0]              
__________________________________________________________________________________________________
time_distributed_47 (TimeDistri (None, 3, 23, 26, 16 64          time_distributed_46[0][0]        
__________________________________________________________________________________________________
time_distributed_48 (TimeDistri (None, 3, 12, 13, 16 2320        time_distributed_47[0][0]        
__________________________________________________________________________________________________
time_distributed_49 (TimeDistri (None, 3, 12, 13, 16 64          time_distributed_48[0][0]        
__________________________________________________________________________________________________
time_distributed_50 (TimeDistri (None, 3, 12, 13, 16 2320        time_distributed_49[0][0]        
__________________________________________________________________________________________________
time_distributed_51 (TimeDistri (None, 3, 12, 13, 16 272         time_distributed_47[0][0]        
__________________________________________________________________________________________________
concatenate_9 (Concatenate)     (None, 3, 12, 13, 32 0           time_distributed_50[0][0]        
                                                                 time_distributed_51[0][0]        
__________________________________________________________________________________________________
time_distributed_52 (TimeDistri (None, 3, 12, 13, 32 0           concatenate_9[0][0]              
__________________________________________________________________________________________________
time_distributed_53 (TimeDistri (None, 3, 12, 13, 32 128         time_distributed_52[0][0]        
__________________________________________________________________________________________________
time_distributed_54 (TimeDistri (None, 3, 6, 7, 32)  9248        time_distributed_53[0][0]        
__________________________________________________________________________________________________
time_distributed_55 (TimeDistri (None, 3, 6, 7, 32)  128         time_distributed_54[0][0]        
__________________________________________________________________________________________________
time_distributed_56 (TimeDistri (None, 3, 6, 7, 32)  9248        time_distributed_55[0][0]        
__________________________________________________________________________________________________
time_distributed_57 (TimeDistri (None, 3, 6, 7, 32)  1056        time_distributed_53[0][0]        
__________________________________________________________________________________________________
concatenate_10 (Concatenate)    (None, 3, 6, 7, 64)  0           time_distributed_56[0][0]        
                                                                 time_distributed_57[0][0]        
__________________________________________________________________________________________________
time_distributed_58 (TimeDistri (None, 3, 6, 7, 64)  0           concatenate_10[0][0]             
__________________________________________________________________________________________________
time_distributed_59 (TimeDistri (None, 3, 6, 7, 64)  256         time_distributed_58[0][0]        
__________________________________________________________________________________________________
conv3d_1 (Conv3D)               (None, 1, 6, 7, 32)  6176        time_distributed_59[0][0]        
__________________________________________________________________________________________________
flatten_3 (Flatten)             (None, 1344)         0           conv3d_1[0][0]                   
__________________________________________________________________________________________________
dense_6 (Dense)                 (None, 20)           26900       flatten_3[0][0]                  
__________________________________________________________________________________________________
dropout_3 (Dropout)             (None, 20)           0           dense_6[0][0]                    
__________________________________________________________________________________________________
dense_7 (Dense)                 (None, 1358)         28518       dropout_3[0][0]                  
==================================================================================================
Total params: 87,650
Trainable params: 87,314
Non-trainable params: 336
__________________________________________________________________________________________________
None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">)</span>
<span class="n">model_resnet</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history_rest</span> <span class="o">=</span> <span class="n">model_resnet</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dset_train</span><span class="p">,</span>
                                       <span class="n">validation_data</span><span class="o">=</span><span class="n">dset_val</span><span class="p">,</span>
                                       <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/50
4857/4857 [==============================] - 35s 7ms/step - loss: 45.7078 - mse: 45.6063 - mae: 5.1409 - val_loss: 32.6204 - val_mse: 32.5160 - val_mae: 4.3658
Epoch 2/50
4857/4857 [==============================] - 34s 7ms/step - loss: 30.8256 - mse: 30.7190 - mae: 4.2528 - val_loss: 25.5706 - val_mse: 25.4619 - val_mae: 3.8668
Epoch 3/50
4857/4857 [==============================] - 34s 7ms/step - loss: 26.5719 - mse: 26.4622 - mae: 3.9533 - val_loss: 23.9186 - val_mse: 23.8080 - val_mae: 3.7489
Epoch 4/50
4857/4857 [==============================] - 34s 7ms/step - loss: 24.9605 - mse: 24.8492 - mae: 3.8354 - val_loss: 23.1535 - val_mse: 23.0414 - val_mae: 3.6948
Epoch 5/50
4857/4857 [==============================] - 34s 7ms/step - loss: 23.7941 - mse: 23.6812 - mae: 3.7473 - val_loss: 22.5183 - val_mse: 22.4045 - val_mae: 3.6486
Epoch 6/50
4857/4857 [==============================] - 37s 8ms/step - loss: 22.8768 - mse: 22.7621 - mae: 3.6754 - val_loss: 21.9116 - val_mse: 21.7961 - val_mae: 3.6019
Epoch 7/50
4857/4857 [==============================] - 41s 8ms/step - loss: 22.1118 - mse: 21.9955 - mae: 3.6157 - val_loss: 21.5925 - val_mse: 21.4754 - val_mae: 3.5808
Epoch 8/50
4857/4857 [==============================] - 41s 9ms/step - loss: 21.4819 - mse: 21.3640 - mae: 3.5662 - val_loss: 21.3028 - val_mse: 21.1841 - val_mae: 3.5605
Epoch 9/50
4857/4857 [==============================] - 35s 7ms/step - loss: 20.9548 - mse: 20.8355 - mae: 3.5240 - val_loss: 21.0499 - val_mse: 20.9298 - val_mae: 3.5402
Epoch 10/50
4857/4857 [==============================] - 38s 8ms/step - loss: 20.4666 - mse: 20.3458 - mae: 3.4845 - val_loss: 20.8741 - val_mse: 20.7525 - val_mae: 3.5292
Epoch 11/50
4857/4857 [==============================] - 34s 7ms/step - loss: 20.0578 - mse: 19.9355 - mae: 3.4515 - val_loss: 20.8221 - val_mse: 20.6992 - val_mae: 3.5287
Epoch 12/50
4857/4857 [==============================] - 34s 7ms/step - loss: 19.6798 - mse: 19.5561 - mae: 3.4192 - val_loss: 20.9890 - val_mse: 20.8646 - val_mae: 3.5471
Epoch 13/50
4857/4857 [==============================] - 34s 7ms/step - loss: 19.2555 - mse: 19.1305 - mae: 3.3856 - val_loss: 20.8546 - val_mse: 20.7289 - val_mae: 3.5368
Epoch 14/50
4857/4857 [==============================] - 34s 7ms/step - loss: 18.9128 - mse: 18.7864 - mae: 3.3572 - val_loss: 20.6269 - val_mse: 20.5000 - val_mae: 3.5179
Epoch 15/50
4857/4857 [==============================] - 34s 7ms/step - loss: 18.5450 - mse: 18.4174 - mae: 3.3243 - val_loss: 20.7665 - val_mse: 20.6383 - val_mae: 3.5328
Epoch 16/50
4857/4857 [==============================] - 34s 7ms/step - loss: 18.2064 - mse: 18.0775 - mae: 3.2935 - val_loss: 20.8955 - val_mse: 20.7659 - val_mae: 3.5474
Epoch 17/50
4857/4857 [==============================] - 34s 7ms/step - loss: 17.9058 - mse: 17.7756 - mae: 3.2699 - val_loss: 20.7586 - val_mse: 20.6279 - val_mae: 3.5338
Epoch 18/50
4857/4857 [==============================] - 34s 7ms/step - loss: 17.5831 - mse: 17.4517 - mae: 3.2406 - val_loss: 20.7484 - val_mse: 20.6165 - val_mae: 3.5340
Epoch 19/50
4857/4857 [==============================] - 34s 7ms/step - loss: 17.2591 - mse: 17.1266 - mae: 3.2119 - val_loss: 20.9504 - val_mse: 20.8173 - val_mae: 3.5532
Epoch 20/50
4857/4857 [==============================] - 34s 7ms/step - loss: 16.9413 - mse: 16.8076 - mae: 3.1834 - val_loss: 21.0352 - val_mse: 20.9009 - val_mae: 3.5608
Epoch 21/50
4857/4857 [==============================] - 34s 7ms/step - loss: 16.6801 - mse: 16.5454 - mae: 3.1590 - val_loss: 20.9801 - val_mse: 20.8448 - val_mae: 3.5546
Epoch 22/50
4857/4857 [==============================] - 34s 7ms/step - loss: 16.4371 - mse: 16.3013 - mae: 3.1351 - val_loss: 21.1959 - val_mse: 21.0596 - val_mae: 3.5757
Epoch 23/50
4857/4857 [==============================] - 34s 7ms/step - loss: 16.1893 - mse: 16.0525 - mae: 3.1126 - val_loss: 21.1656 - val_mse: 21.0282 - val_mae: 3.5709
Epoch 24/50
4857/4857 [==============================] - 34s 7ms/step - loss: 15.9103 - mse: 15.7725 - mae: 3.0861 - val_loss: 21.4005 - val_mse: 21.2622 - val_mae: 3.5922
Epoch 25/50
4857/4857 [==============================] - 34s 7ms/step - loss: 15.6702 - mse: 15.5313 - mae: 3.0638 - val_loss: 21.3296 - val_mse: 21.1903 - val_mae: 3.5865
Epoch 26/50
4857/4857 [==============================] - 34s 7ms/step - loss: 15.4429 - mse: 15.3032 - mae: 3.0418 - val_loss: 21.4508 - val_mse: 21.3107 - val_mae: 3.5945
Epoch 27/50
4857/4857 [==============================] - 34s 7ms/step - loss: 15.2504 - mse: 15.1098 - mae: 3.0223 - val_loss: 21.6502 - val_mse: 21.5091 - val_mae: 3.6116
Epoch 28/50
4857/4857 [==============================] - 34s 7ms/step - loss: 15.0352 - mse: 14.8936 - mae: 3.0008 - val_loss: 21.7320 - val_mse: 21.5901 - val_mae: 3.6172
Epoch 29/50
4857/4857 [==============================] - 34s 7ms/step - loss: 14.8624 - mse: 14.7200 - mae: 2.9824 - val_loss: 21.7816 - val_mse: 21.6388 - val_mae: 3.6210
Epoch 30/50
4857/4857 [==============================] - 34s 7ms/step - loss: 14.6541 - mse: 14.5109 - mae: 2.9615 - val_loss: 21.8946 - val_mse: 21.7510 - val_mae: 3.6316
Epoch 31/50
4857/4857 [==============================] - 34s 7ms/step - loss: 14.4000 - mse: 14.2559 - mae: 2.9371 - val_loss: 21.8440 - val_mse: 21.6996 - val_mae: 3.6268
Epoch 32/50
4857/4857 [==============================] - 34s 7ms/step - loss: 14.2724 - mse: 14.1276 - mae: 2.9241 - val_loss: 21.9605 - val_mse: 21.8154 - val_mae: 3.6357
Epoch 33/50
4857/4857 [==============================] - 34s 7ms/step - loss: 14.1248 - mse: 13.9793 - mae: 2.9074 - val_loss: 22.0458 - val_mse: 21.8999 - val_mae: 3.6415
Epoch 34/50
4857/4857 [==============================] - 34s 7ms/step - loss: 13.9484 - mse: 13.8023 - mae: 2.8886 - val_loss: 22.0997 - val_mse: 21.9532 - val_mae: 3.6453
Epoch 35/50
4857/4857 [==============================] - 34s 7ms/step - loss: 13.7594 - mse: 13.6125 - mae: 2.8700 - val_loss: 22.0677 - val_mse: 21.9205 - val_mae: 3.6422
Epoch 36/50
4857/4857 [==============================] - 34s 7ms/step - loss: 13.6483 - mse: 13.5008 - mae: 2.8574 - val_loss: 22.0961 - val_mse: 21.9482 - val_mae: 3.6446
Epoch 37/50
4857/4857 [==============================] - 34s 7ms/step - loss: 13.4629 - mse: 13.3148 - mae: 2.8369 - val_loss: 22.3403 - val_mse: 22.1918 - val_mae: 3.6652
Epoch 38/50
4857/4857 [==============================] - 34s 7ms/step - loss: 13.3301 - mse: 13.1813 - mae: 2.8237 - val_loss: 22.4712 - val_mse: 22.3222 - val_mae: 3.6765
Epoch 39/50
4857/4857 [==============================] - 34s 7ms/step - loss: 13.2128 - mse: 13.0635 - mae: 2.8117 - val_loss: 22.5599 - val_mse: 22.4103 - val_mae: 3.6820
Epoch 40/50
4857/4857 [==============================] - 34s 7ms/step - loss: 13.0824 - mse: 12.9325 - mae: 2.7958 - val_loss: 22.4234 - val_mse: 22.2732 - val_mae: 3.6703
Epoch 41/50
4857/4857 [==============================] - 34s 7ms/step - loss: 12.9569 - mse: 12.8065 - mae: 2.7821 - val_loss: 22.6425 - val_mse: 22.4918 - val_mae: 3.6892
Epoch 42/50
4857/4857 [==============================] - 34s 7ms/step - loss: 12.8098 - mse: 12.6589 - mae: 2.7669 - val_loss: 22.6346 - val_mse: 22.4834 - val_mae: 3.6859
Epoch 43/50
4857/4857 [==============================] - 36s 7ms/step - loss: 12.6980 - mse: 12.5466 - mae: 2.7543 - val_loss: 22.7599 - val_mse: 22.6083 - val_mae: 3.6988
Epoch 44/50
4857/4857 [==============================] - 37s 8ms/step - loss: 12.5865 - mse: 12.4346 - mae: 2.7425 - val_loss: 22.7669 - val_mse: 22.6148 - val_mae: 3.6969
Epoch 45/50
4857/4857 [==============================] - 34s 7ms/step - loss: 12.4743 - mse: 12.3220 - mae: 2.7298 - val_loss: 22.8735 - val_mse: 22.7209 - val_mae: 3.7065
Epoch 46/50
4857/4857 [==============================] - 34s 7ms/step - loss: 12.3864 - mse: 12.2337 - mae: 2.7187 - val_loss: 22.8616 - val_mse: 22.7086 - val_mae: 3.7029
Epoch 47/50
4857/4857 [==============================] - 34s 7ms/step - loss: 12.2960 - mse: 12.1428 - mae: 2.7098 - val_loss: 23.0326 - val_mse: 22.8792 - val_mae: 3.7164
Epoch 48/50
4857/4857 [==============================] - 34s 7ms/step - loss: 12.1851 - mse: 12.0316 - mae: 2.6973 - val_loss: 23.0235 - val_mse: 22.8698 - val_mae: 3.7176
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 49/50
4857/4857 [==============================] - 34s 7ms/step - loss: 12.1177 - mse: 11.9637 - mae: 2.6894 - val_loss: 22.8477 - val_mse: 22.6936 - val_mae: 3.7000
Epoch 50/50
4857/4857 [==============================] - 34s 7ms/step - loss: 11.9800 - mse: 11.8257 - mae: 2.6732 - val_loss: 22.9976 - val_mse: 22.8432 - val_mae: 3.7125
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">4857</span><span class="o">/</span><span class="mi">4857</span> <span class="p">[</span><span class="o">==============================</span><span class="p">]</span> <span class="o">-</span> <span class="mi">40</span><span class="n">s</span> <span class="mi">8</span><span class="n">ms</span><span class="o">/</span><span class="n">step</span> <span class="o">-</span> <span class="n">loss</span><span class="p">:</span> <span class="mf">20.6508</span> <span class="o">-</span> <span class="n">mse</span><span class="p">:</span> <span class="mf">20.5873</span> <span class="o">-</span> <span class="n">mae</span><span class="p">:</span> <span class="mf">3.4932</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">19.4964</span> <span class="o">-</span> <span class="n">val_mse</span><span class="p">:</span> <span class="mf">19.4329</span> <span class="o">-</span> <span class="n">val_mae</span><span class="p">:</span> <span class="mf">3.4064</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_rest</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_rest</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fcbfcc3f3a0&gt;
</pre></div>
</div>
<img alt="../_images/model_CNN-regional_1_34_1.png" src="../_images/model_CNN-regional_1_34_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_rest</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history_rest</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7fcbfdd62910&gt;
</pre></div>
</div>
<img alt="../_images/model_CNN-regional_1_35_1.png" src="../_images/model_CNN-regional_1_35_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_val_resnet</span> <span class="o">=</span> <span class="n">model_resnet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dset_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats_val_resnet</span> <span class="o">=</span> <span class="n">calculate_coast_stats</span><span class="p">(</span><span class="n">dset_val</span><span class="p">,</span> <span class="n">prediction_val_resnet</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">linear_results</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;/home/metocean/geocean-nz-ss/data/statistics/experiments/experiment_linear_final_20211113.nc&#39;</span><span class="p">)</span>
<span class="n">best_linear_results</span> <span class="o">=</span> <span class="n">linear_results</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">winds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tlapse</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s1">&#39;local_2.5_2.5&#39;</span><span class="p">,</span> <span class="n">tresample</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>
<span class="n">best_linear_results</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;kgeprime&#39;</span><span class="p">]</span>

<span class="n">sites_linear</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">lons_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">sites_nn</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span>
<span class="n">lons_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    
    <span class="n">vals_linear</span> <span class="o">=</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals_nn</span> <span class="o">=</span> <span class="n">stats_val_resnet</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    
    <span class="n">vals_diff</span> <span class="o">=</span> <span class="n">vals_linear</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stats_val_resnet</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sites_nn</span><span class="o">==</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_linear</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    
    <span class="n">vdiff_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals_diff</span><span class="p">))</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_linear</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_nn</span><span class="p">,</span> <span class="n">lats_nn</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_nn</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                         <span class="n">c</span><span class="o">=</span><span class="n">vals_diff</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vdiff_max</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vdiff_max</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model minus CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites_linear</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">lons_linear</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lats_linear</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        
<span class="c1"># Comparison standard CNN with multilinear model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/model_CNN-regional_1_38_0.png" src="../_images/model_CNN-regional_1_38_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;kgeprime&#39;</span><span class="p">]</span>

<span class="n">sites</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    
    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr_r&#39;</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">]:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span>
    
    <span class="n">vals_fancy</span> <span class="o">=</span> <span class="n">stats_val</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    <span class="n">vals_nn</span> <span class="o">=</span> <span class="n">stats_val_resnet</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    
    <span class="n">vals_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stats_val</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>\
                 <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stats_val_resnet</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_fancy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_fancy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    
    <span class="n">vdiff_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals_diff</span><span class="p">))</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_fancy</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fancy CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_nn</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                         <span class="n">c</span><span class="o">=</span><span class="n">vals_diff</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vdiff_max</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vdiff_max</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fancy CNN model minus CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
        
<span class="c1"># Comparison with fancy nn</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/model_CNN-regional_1_39_0.png" src="../_images/model_CNN-regional_1_39_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_val_last</span> <span class="o">=</span> <span class="n">model_resnet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dset_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats_val_last</span> <span class="o">=</span> <span class="n">calculate_coast_stats</span><span class="p">(</span><span class="n">dset_val</span><span class="p">,</span> <span class="n">prediction_val_last</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;kgeprime&#39;</span><span class="p">]</span>

<span class="n">sites</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>

<span class="n">stats_val1</span> <span class="o">=</span> <span class="n">stats_val_resnet</span>
<span class="n">stats_val2</span> <span class="o">=</span> <span class="n">stats_val_last</span>

<span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    
    <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr_r&#39;</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">]:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span>
    
    <span class="n">vals_fancy</span> <span class="o">=</span> <span class="n">stats_val1</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    <span class="n">vals_nn</span> <span class="o">=</span> <span class="n">stats_val2</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    
    <span class="n">vals_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stats_val1</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>\
                 <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stats_val2</span><span class="p">[</span><span class="n">metric</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_fancy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_fancy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    
    <span class="n">vdiff_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals_diff</span><span class="p">))</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_fancy</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fancy CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_nn</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span>
                         <span class="n">c</span><span class="o">=</span><span class="n">vals_diff</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vdiff_max</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vdiff_max</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fancy CNN model minus CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
        
<span class="c1"># Comparison with fancy nn</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/model_CNN-regional_1_42_0.png" src="../_images/model_CNN-regional_1_42_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">cnn_filters</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span> <span class="p">]:</span>
    <span class="k">for</span> <span class="n">dense</span> <span class="ow">in</span> <span class="p">[[</span><span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]]:</span>

        <span class="n">build_resnet_model</span><span class="p">(</span><span class="n">shape_in</span><span class="p">,</span>
                           <span class="n">nbout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">cnn_filters</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">],</span>
                           <span class="n">dense</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">])</span>

        <span class="n">shape_in</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),)</span> <span class="o">+</span> <span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">model_resnet</span> <span class="o">=</span> <span class="n">build_resnet_model</span><span class="p">(</span><span class="n">shape_in</span><span class="o">=</span><span class="n">shape_in</span><span class="p">,</span>
                                          <span class="n">nbout</span><span class="o">=</span><span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">cnn_filters</span><span class="o">=</span><span class="n">cnn_filters</span><span class="p">,</span>
                                          <span class="n">dense</span><span class="o">=</span><span class="n">dense</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">)</span>
        <span class="n">model_resnet</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="p">,</span>
            <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">]</span>
        <span class="p">)</span>
                   
        <span class="n">cnn_config</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cnn_filters</span><span class="p">])</span>
        <span class="n">dense_config</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dense</span><span class="p">])</span>
        
        <span class="n">results</span><span class="p">[</span><span class="n">cnn_config</span><span class="p">][</span><span class="n">dense_config</span><span class="p">][</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_resnet</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dset_train</span><span class="p">,</span>
                                                                        <span class="n">validation_data</span><span class="o">=</span><span class="n">dset_val</span><span class="p">,</span>
                                                                        <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        
        <span class="n">prediction_val_resnet</span> <span class="o">=</span> <span class="n">model_resnet</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dset_val</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">cnn_config</span><span class="p">][</span><span class="n">dense_config</span><span class="p">][</span><span class="s1">&#39;stats_val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_coast_stats</span><span class="p">(</span><span class="n">dset_val</span><span class="p">,</span> <span class="n">prediction_val_resnet</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model_10&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_41 (InputLayer)           [(None, 3, 45, 51, 4 0                                            
__________________________________________________________________________________________________
time_distributed_194 (TimeDistr (None, 3, 23, 26, 6) 222         input_41[0][0]                   
__________________________________________________________________________________________________
time_distributed_195 (TimeDistr (None, 3, 23, 26, 6) 24          time_distributed_194[0][0]       
__________________________________________________________________________________________________
time_distributed_196 (TimeDistr (None, 3, 23, 26, 6) 330         time_distributed_195[0][0]       
__________________________________________________________________________________________________
time_distributed_197 (TimeDistr (None, 3, 23, 26, 6) 30          input_41[0][0]                   
__________________________________________________________________________________________________
concatenate_38 (Concatenate)    (None, 3, 23, 26, 12 0           time_distributed_196[0][0]       
                                                                 time_distributed_197[0][0]       
__________________________________________________________________________________________________
time_distributed_198 (TimeDistr (None, 3, 23, 26, 12 0           concatenate_38[0][0]             
__________________________________________________________________________________________________
time_distributed_199 (TimeDistr (None, 3, 23, 26, 12 48          time_distributed_198[0][0]       
__________________________________________________________________________________________________
time_distributed_200 (TimeDistr (None, 3, 12, 13, 12 1308        time_distributed_199[0][0]       
__________________________________________________________________________________________________
time_distributed_201 (TimeDistr (None, 3, 12, 13, 12 48          time_distributed_200[0][0]       
__________________________________________________________________________________________________
time_distributed_202 (TimeDistr (None, 3, 12, 13, 12 1308        time_distributed_201[0][0]       
__________________________________________________________________________________________________
time_distributed_203 (TimeDistr (None, 3, 12, 13, 12 156         time_distributed_199[0][0]       
__________________________________________________________________________________________________
concatenate_39 (Concatenate)    (None, 3, 12, 13, 24 0           time_distributed_202[0][0]       
                                                                 time_distributed_203[0][0]       
__________________________________________________________________________________________________
time_distributed_204 (TimeDistr (None, 3, 12, 13, 24 0           concatenate_39[0][0]             
__________________________________________________________________________________________________
time_distributed_205 (TimeDistr (None, 3, 12, 13, 24 96          time_distributed_204[0][0]       
__________________________________________________________________________________________________
time_distributed_206 (TimeDistr (None, 3, 6, 7, 24)  5208        time_distributed_205[0][0]       
__________________________________________________________________________________________________
time_distributed_207 (TimeDistr (None, 3, 6, 7, 24)  96          time_distributed_206[0][0]       
__________________________________________________________________________________________________
time_distributed_208 (TimeDistr (None, 3, 6, 7, 24)  5208        time_distributed_207[0][0]       
__________________________________________________________________________________________________
time_distributed_209 (TimeDistr (None, 3, 6, 7, 24)  600         time_distributed_205[0][0]       
__________________________________________________________________________________________________
concatenate_40 (Concatenate)    (None, 3, 6, 7, 48)  0           time_distributed_208[0][0]       
                                                                 time_distributed_209[0][0]       
__________________________________________________________________________________________________
time_distributed_210 (TimeDistr (None, 3, 6, 7, 48)  0           concatenate_40[0][0]             
__________________________________________________________________________________________________
time_distributed_211 (TimeDistr (None, 3, 6, 7, 48)  192         time_distributed_210[0][0]       
__________________________________________________________________________________________________
conv3d_6 (Conv3D)               (None, 1, 6, 7, 24)  3480        time_distributed_211[0][0]       
__________________________________________________________________________________________________
flatten_10 (Flatten)            (None, 1008)         0           conv3d_6[0][0]                   
__________________________________________________________________________________________________
dense_20 (Dense)                (None, 50)           50450       flatten_10[0][0]                 
__________________________________________________________________________________________________
dropout_10 (Dropout)            (None, 50)           0           dense_20[0][0]                   
__________________________________________________________________________________________________
dense_21 (Dense)                (None, 1)            51          dropout_10[0][0]                 
==================================================================================================
Total params: 68,855
Trainable params: 68,603
Non-trainable params: 252
__________________________________________________________________________________________________
None
Model: &quot;model_11&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_42 (InputLayer)           [(None, 3, 45, 51, 4 0                                            
__________________________________________________________________________________________________
time_distributed_212 (TimeDistr (None, 3, 23, 26, 6) 222         input_42[0][0]                   
__________________________________________________________________________________________________
time_distributed_213 (TimeDistr (None, 3, 23, 26, 6) 24          time_distributed_212[0][0]       
__________________________________________________________________________________________________
time_distributed_214 (TimeDistr (None, 3, 23, 26, 6) 330         time_distributed_213[0][0]       
__________________________________________________________________________________________________
time_distributed_215 (TimeDistr (None, 3, 23, 26, 6) 30          input_42[0][0]                   
__________________________________________________________________________________________________
concatenate_41 (Concatenate)    (None, 3, 23, 26, 12 0           time_distributed_214[0][0]       
                                                                 time_distributed_215[0][0]       
__________________________________________________________________________________________________
time_distributed_216 (TimeDistr (None, 3, 23, 26, 12 0           concatenate_41[0][0]             
__________________________________________________________________________________________________
time_distributed_217 (TimeDistr (None, 3, 23, 26, 12 48          time_distributed_216[0][0]       
__________________________________________________________________________________________________
time_distributed_218 (TimeDistr (None, 3, 12, 13, 12 1308        time_distributed_217[0][0]       
__________________________________________________________________________________________________
time_distributed_219 (TimeDistr (None, 3, 12, 13, 12 48          time_distributed_218[0][0]       
__________________________________________________________________________________________________
time_distributed_220 (TimeDistr (None, 3, 12, 13, 12 1308        time_distributed_219[0][0]       
__________________________________________________________________________________________________
time_distributed_221 (TimeDistr (None, 3, 12, 13, 12 156         time_distributed_217[0][0]       
__________________________________________________________________________________________________
concatenate_42 (Concatenate)    (None, 3, 12, 13, 24 0           time_distributed_220[0][0]       
                                                                 time_distributed_221[0][0]       
__________________________________________________________________________________________________
time_distributed_222 (TimeDistr (None, 3, 12, 13, 24 0           concatenate_42[0][0]             
__________________________________________________________________________________________________
time_distributed_223 (TimeDistr (None, 3, 12, 13, 24 96          time_distributed_222[0][0]       
__________________________________________________________________________________________________
time_distributed_224 (TimeDistr (None, 3, 6, 7, 24)  5208        time_distributed_223[0][0]       
__________________________________________________________________________________________________
time_distributed_225 (TimeDistr (None, 3, 6, 7, 24)  96          time_distributed_224[0][0]       
__________________________________________________________________________________________________
time_distributed_226 (TimeDistr (None, 3, 6, 7, 24)  5208        time_distributed_225[0][0]       
__________________________________________________________________________________________________
time_distributed_227 (TimeDistr (None, 3, 6, 7, 24)  600         time_distributed_223[0][0]       
__________________________________________________________________________________________________
concatenate_43 (Concatenate)    (None, 3, 6, 7, 48)  0           time_distributed_226[0][0]       
                                                                 time_distributed_227[0][0]       
__________________________________________________________________________________________________
time_distributed_228 (TimeDistr (None, 3, 6, 7, 48)  0           concatenate_43[0][0]             
__________________________________________________________________________________________________
time_distributed_229 (TimeDistr (None, 3, 6, 7, 48)  192         time_distributed_228[0][0]       
__________________________________________________________________________________________________
conv3d_7 (Conv3D)               (None, 1, 6, 7, 24)  3480        time_distributed_229[0][0]       
__________________________________________________________________________________________________
flatten_11 (Flatten)            (None, 1008)         0           conv3d_7[0][0]                   
__________________________________________________________________________________________________
dense_22 (Dense)                (None, 10)           10090       flatten_11[0][0]                 
__________________________________________________________________________________________________
dropout_11 (Dropout)            (None, 10)           0           dense_22[0][0]                   
__________________________________________________________________________________________________
dense_23 (Dense)                (None, 1358)         14938       dropout_11[0][0]                 
==================================================================================================
Total params: 43,382
Trainable params: 43,130
Non-trainable params: 252
__________________________________________________________________________________________________
None
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/50
4857/4857 [==============================] - 42s 8ms/step - loss: 53.3148 - mse: 53.2920 - mae: 5.5816 - val_loss: 39.2757 - val_mse: 39.2512 - val_mae: 4.8313
Epoch 2/50
4857/4857 [==============================] - 40s 8ms/step - loss: 42.5563 - mse: 42.5316 - mae: 5.0374 - val_loss: 38.3924 - val_mse: 38.3677 - val_mae: 4.7739
Epoch 3/50
4857/4857 [==============================] - 40s 8ms/step - loss: 40.9689 - mse: 40.9438 - mae: 4.9350 - val_loss: 36.8284 - val_mse: 36.8028 - val_mae: 4.6683
Epoch 4/50
4857/4857 [==============================] - 41s 8ms/step - loss: 38.4830 - mse: 38.4567 - mae: 4.7715 - val_loss: 33.4761 - val_mse: 33.4488 - val_mae: 4.4381
Epoch 5/50
4857/4857 [==============================] - 41s 8ms/step - loss: 35.9132 - mse: 35.8852 - mae: 4.5996 - val_loss: 31.4178 - val_mse: 31.3892 - val_mae: 4.2959
Epoch 6/50
4857/4857 [==============================] - 40s 8ms/step - loss: 34.7457 - mse: 34.7165 - mae: 4.5228 - val_loss: 30.7195 - val_mse: 30.6900 - val_mae: 4.2486
Epoch 7/50
4857/4857 [==============================] - 41s 8ms/step - loss: 34.0485 - mse: 34.0186 - mae: 4.4768 - val_loss: 30.3029 - val_mse: 30.2725 - val_mae: 4.2195
Epoch 8/50
4857/4857 [==============================] - 41s 8ms/step - loss: 33.4352 - mse: 33.4045 - mae: 4.4376 - val_loss: 29.8611 - val_mse: 29.8299 - val_mae: 4.1909
Epoch 9/50
4857/4857 [==============================] - 40s 8ms/step - loss: 32.8769 - mse: 32.8454 - mae: 4.4009 - val_loss: 29.3431 - val_mse: 29.3111 - val_mae: 4.1570
Epoch 10/50
4857/4857 [==============================] - 41s 8ms/step - loss: 32.0868 - mse: 32.0544 - mae: 4.3522 - val_loss: 28.5540 - val_mse: 28.5212 - val_mae: 4.1090
Epoch 11/50
4857/4857 [==============================] - 41s 8ms/step - loss: 30.6391 - mse: 30.6057 - mae: 4.2627 - val_loss: 26.3118 - val_mse: 26.2778 - val_mae: 3.9501
Epoch 12/50
4857/4857 [==============================] - 41s 8ms/step - loss: 28.4102 - mse: 28.3757 - mae: 4.0966 - val_loss: 24.6427 - val_mse: 24.6078 - val_mae: 3.8192
Epoch 13/50
4857/4857 [==============================] - 40s 8ms/step - loss: 27.3897 - mse: 27.3544 - mae: 4.0142 - val_loss: 24.2720 - val_mse: 24.2363 - val_mae: 3.7930
Epoch 14/50
4857/4857 [==============================] - 41s 8ms/step - loss: 26.7830 - mse: 26.7470 - mae: 3.9685 - val_loss: 24.1688 - val_mse: 24.1323 - val_mae: 3.7876
Epoch 15/50
4857/4857 [==============================] - 41s 8ms/step - loss: 26.5674 - mse: 26.5305 - mae: 3.9519 - val_loss: 23.9421 - val_mse: 23.9050 - val_mae: 3.7708
Epoch 16/50
4857/4857 [==============================] - 40s 8ms/step - loss: 26.2075 - mse: 26.1700 - mae: 3.9210 - val_loss: 23.8763 - val_mse: 23.8385 - val_mae: 3.7655
Epoch 17/50
4857/4857 [==============================] - 41s 8ms/step - loss: 25.8400 - mse: 25.8019 - mae: 3.8958 - val_loss: 23.7654 - val_mse: 23.7269 - val_mae: 3.7586
Epoch 18/50
4857/4857 [==============================] - 41s 8ms/step - loss: 25.5344 - mse: 25.4956 - mae: 3.8729 - val_loss: 23.6981 - val_mse: 23.6590 - val_mae: 3.7551
Epoch 19/50
4857/4857 [==============================] - 40s 8ms/step - loss: 25.2832 - mse: 25.2438 - mae: 3.8539 - val_loss: 23.7163 - val_mse: 23.6766 - val_mae: 3.7576
Epoch 20/50
4857/4857 [==============================] - 40s 8ms/step - loss: 25.1293 - mse: 25.0893 - mae: 3.8417 - val_loss: 23.5770 - val_mse: 23.5367 - val_mae: 3.7449
Epoch 21/50
4857/4857 [==============================] - 41s 8ms/step - loss: 24.8683 - mse: 24.8277 - mae: 3.8208 - val_loss: 23.7203 - val_mse: 23.6794 - val_mae: 3.7599
Epoch 22/50
4857/4857 [==============================] - 41s 8ms/step - loss: 24.6993 - mse: 24.6582 - mae: 3.8089 - val_loss: 23.5548 - val_mse: 23.5134 - val_mae: 3.7466
Epoch 23/50
4857/4857 [==============================] - 40s 8ms/step - loss: 24.4565 - mse: 24.4148 - mae: 3.7907 - val_loss: 23.6058 - val_mse: 23.5639 - val_mae: 3.7521
Epoch 24/50
4857/4857 [==============================] - 41s 8ms/step - loss: 24.2895 - mse: 24.2472 - mae: 3.7753 - val_loss: 23.6505 - val_mse: 23.6080 - val_mae: 3.7563
Epoch 25/50
4857/4857 [==============================] - 41s 8ms/step - loss: 24.1342 - mse: 24.0914 - mae: 3.7635 - val_loss: 23.8163 - val_mse: 23.7733 - val_mae: 3.7708
Epoch 26/50
4857/4857 [==============================] - 40s 8ms/step - loss: 23.9519 - mse: 23.9086 - mae: 3.7491 - val_loss: 23.6935 - val_mse: 23.6500 - val_mae: 3.7615
Epoch 27/50
4857/4857 [==============================] - 41s 8ms/step - loss: 23.7754 - mse: 23.7316 - mae: 3.7365 - val_loss: 23.5558 - val_mse: 23.5117 - val_mae: 3.7497
Epoch 28/50
4857/4857 [==============================] - 41s 8ms/step - loss: 23.5907 - mse: 23.5463 - mae: 3.7219 - val_loss: 23.7532 - val_mse: 23.7087 - val_mae: 3.7663
Epoch 29/50
4857/4857 [==============================] - 41s 8ms/step - loss: 23.5349 - mse: 23.4901 - mae: 3.7139 - val_loss: 23.9080 - val_mse: 23.8630 - val_mae: 3.7802
Epoch 30/50
4857/4857 [==============================] - 41s 8ms/step - loss: 23.2716 - mse: 23.2263 - mae: 3.6938 - val_loss: 24.0034 - val_mse: 23.9579 - val_mae: 3.7893
Epoch 31/50
4857/4857 [==============================] - 41s 8ms/step - loss: 23.1268 - mse: 23.0810 - mae: 3.6838 - val_loss: 23.9821 - val_mse: 23.9361 - val_mae: 3.7846
Epoch 32/50
4857/4857 [==============================] - 41s 8ms/step - loss: 23.0653 - mse: 23.0191 - mae: 3.6765 - val_loss: 24.2594 - val_mse: 24.2130 - val_mae: 3.8087
Epoch 33/50
4857/4857 [==============================] - 40s 8ms/step - loss: 22.8759 - mse: 22.8292 - mae: 3.6604 - val_loss: 24.2569 - val_mse: 24.2099 - val_mae: 3.8087
Epoch 34/50
4857/4857 [==============================] - 41s 8ms/step - loss: 22.7021 - mse: 22.6550 - mae: 3.6456 - val_loss: 24.4421 - val_mse: 24.3948 - val_mae: 3.8279
Epoch 35/50
4857/4857 [==============================] - 41s 8ms/step - loss: 22.5686 - mse: 22.5210 - mae: 3.6344 - val_loss: 24.7852 - val_mse: 24.7374 - val_mae: 3.8554
Epoch 36/50
4857/4857 [==============================] - 40s 8ms/step - loss: 22.5158 - mse: 22.4677 - mae: 3.6286 - val_loss: 24.4498 - val_mse: 24.4015 - val_mae: 3.8255
Epoch 37/50
4857/4857 [==============================] - 34s 7ms/step - loss: 22.3034 - mse: 22.2549 - mae: 3.6147 - val_loss: 24.4563 - val_mse: 24.4076 - val_mae: 3.8246
Epoch 38/50
4857/4857 [==============================] - 34s 7ms/step - loss: 22.1478 - mse: 22.0989 - mae: 3.5975 - val_loss: 24.8666 - val_mse: 24.8175 - val_mae: 3.8624
Epoch 39/50
4857/4857 [==============================] - 34s 7ms/step - loss: 22.0177 - mse: 21.9684 - mae: 3.5885 - val_loss: 24.5569 - val_mse: 24.5073 - val_mae: 3.8324
Epoch 40/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.8600 - mse: 21.8102 - mae: 3.5761 - val_loss: 25.0090 - val_mse: 24.9590 - val_mae: 3.8694
Epoch 41/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.8245 - mse: 21.7743 - mae: 3.5689 - val_loss: 24.9253 - val_mse: 24.8749 - val_mae: 3.8629
Epoch 42/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.6895 - mse: 21.6389 - mae: 3.5578 - val_loss: 24.9805 - val_mse: 24.9297 - val_mae: 3.8691
Epoch 43/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.6077 - mse: 21.5568 - mae: 3.5488 - val_loss: 25.1224 - val_mse: 25.0712 - val_mae: 3.8801
Epoch 44/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.4908 - mse: 21.4394 - mae: 3.5434 - val_loss: 25.2918 - val_mse: 25.2403 - val_mae: 3.8914
Epoch 45/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.3663 - mse: 21.3146 - mae: 3.5287 - val_loss: 25.0875 - val_mse: 25.0356 - val_mae: 3.8753
Epoch 46/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.2348 - mse: 21.1828 - mae: 3.5192 - val_loss: 25.1997 - val_mse: 25.1474 - val_mae: 3.8852
Epoch 47/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.1360 - mse: 21.0835 - mae: 3.5113 - val_loss: 25.5464 - val_mse: 25.4937 - val_mae: 3.9151
Epoch 48/50
4857/4857 [==============================] - 34s 7ms/step - loss: 21.0946 - mse: 21.0418 - mae: 3.5053 - val_loss: 25.3543 - val_mse: 25.3013 - val_mae: 3.8976
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 49/50
4857/4857 [==============================] - 34s 7ms/step - loss: 20.9497 - mse: 20.8966 - mae: 3.4934 - val_loss: 25.5121 - val_mse: 25.4588 - val_mae: 3.9099
Epoch 50/50
4857/4857 [==============================] - 34s 7ms/step - loss: 20.8670 - mse: 20.8135 - mae: 3.4846 - val_loss: 25.3186 - val_mse: 25.2650 - val_mae: 3.8966
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_1325150</span><span class="o">/</span><span class="mf">2676580176.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>         <span class="n">dense_config</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dense</span><span class="p">])</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> 
<span class="ne">---&gt; </span><span class="mi">25</span>         <span class="n">results</span><span class="p">[</span><span class="n">cnn_config</span><span class="p">][</span><span class="n">dense_config</span><span class="p">][</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_resnet</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dset_train</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span>                                                                         <span class="n">validation_data</span><span class="o">=</span><span class="n">dset_val</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span>                                                                         <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="ne">KeyError</span>: &#39;4_8_12&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resu</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction_old</span> <span class="o">=</span> <span class="n">fancy_model_cnn_regional</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dset_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats_val_old</span> <span class="o">=</span> <span class="n">calculate_coast_stats</span><span class="p">(</span><span class="n">dset_val</span><span class="p">,</span> <span class="n">prediction_old</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">linear_results</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;/home/metocean/geocean-nz-ss/data/statistics/experiments/experiment_linear_final_20211113.nc&#39;</span><span class="p">)</span>
<span class="n">best_linear_results</span> <span class="o">=</span> <span class="n">linear_results</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">winds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tlapse</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s1">&#39;local_2.5_2.5&#39;</span><span class="p">,</span> <span class="n">tresample</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">)</span>
<span class="n">best_linear_results</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;kgeprime&#39;</span><span class="p">]</span>

<span class="n">sites_linear</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">lons_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_linear</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">sites_nn</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">values</span>
<span class="n">lons_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">values</span>
<span class="n">lats_nn</span> <span class="o">=</span> <span class="n">ss_dset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_nn</span><span class="p">)</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    
    <span class="n">vals_linear</span> <span class="o">=</span> <span class="n">best_linear_results</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">site</span><span class="o">=</span><span class="n">sites_linear</span><span class="p">)[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals_nn</span> <span class="o">=</span> <span class="n">stats_val_old</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
    
    <span class="n">vals_diff</span> <span class="o">=</span> <span class="n">vals_linear</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stats_val_old</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sites_nn</span><span class="o">==</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites_linear</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_linear</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vals_nn</span><span class="p">))</span>
    
    <span class="n">vdiff_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals_diff</span><span class="p">))</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_linear</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>

    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_nn</span><span class="p">,</span> <span class="n">lats_nn</span><span class="p">,</span>
                      <span class="n">c</span><span class="o">=</span><span class="n">vals_nn</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons_linear</span><span class="p">,</span> <span class="n">lats_linear</span><span class="p">,</span>
                         <span class="n">c</span><span class="o">=</span><span class="n">vals_diff</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">vdiff_max</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vdiff_max</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;5%&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear model minus CNN model: &quot;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites_linear</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">lons_linear</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lats_linear</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        
<span class="c1"># Comparison standard CNN with multilinear model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/model_CNN-regional_1_49_0.png" src="../_images/model_CNN-regional_1_49_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fancy_model_cnn_regional</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/home/metocean/fancy_model_sav&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:tensorflow:Assets written to: /home/metocean/fancy_model_sav/assets
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fancy_model_cnn_regional</span><span class="o">.</span><span class="n">save_spec</span><span class="p">(</span><span class="s1">&#39;/home/metocean/fancy_model_sav.spec&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([TensorSpec(shape=(None, 3, 45, 51, 4), dtype=tf.float32, name=&#39;input_1&#39;)],
 {})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fancy_model_cnn_regional</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s1">&#39;/home/metocean/fancy_model_sav.weight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape_in</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">input_sequence_length</span><span class="o">/</span><span class="n">input_sequence_frequency</span><span class="p">),)</span> <span class="o">+</span> <span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">fancy_model_redo</span> <span class="o">=</span> <span class="n">build_fancy_model_cnn</span><span class="p">(</span><span class="n">shape_in</span><span class="o">=</span><span class="n">shape_in</span><span class="p">,</span>
                                         <span class="n">nbout</span><span class="o">=</span><span class="n">dset_train</span><span class="o">.</span><span class="n">element_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(None, 3, 45, 51, 24) (None, 3, 45, 51, 4)
SS (None, 1, 49, 24) (None, 1, 43, 24) (None, 1, 1, 24)
Model: &quot;model_12&quot;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_43 (InputLayer)           [(None, 3, 45, 51, 4 0                                            
__________________________________________________________________________________________________
time_distributed_230 (TimeDistr (None, 3, 45, 51, 6) 222         input_43[0][0]                   
__________________________________________________________________________________________________
time_distributed_231 (TimeDistr (None, 3, 45, 51, 12 660         time_distributed_230[0][0]       
__________________________________________________________________________________________________
time_distributed_232 (TimeDistr (None, 3, 45, 51, 24 2616        time_distributed_231[0][0]       
__________________________________________________________________________________________________
concatenate_44 (Concatenate)    (None, 3, 45, 51, 28 0           time_distributed_232[0][0]       
                                                                 input_43[0][0]                   
__________________________________________________________________________________________________
time_distributed_233 (TimeDistr (None, 3, 45, 51, 24 696         concatenate_44[0][0]             
__________________________________________________________________________________________________
time_distributed_234 (TimeDistr (None, 3, 24)        0           time_distributed_233[0][0]       
__________________________________________________________________________________________________
tf.math.reduce_sum_26 (TFOpLamb (None, 3, 51, 24)    0           time_distributed_233[0][0]       
__________________________________________________________________________________________________
tf.math.reduce_sum_27 (TFOpLamb (None, 3, 45, 24)    0           time_distributed_233[0][0]       
__________________________________________________________________________________________________
conv1d_13 (Conv1D)              (None, 1, 24)        1752        time_distributed_234[0][0]       
__________________________________________________________________________________________________
conv2d_172 (Conv2D)             (None, 1, 49, 24)    5208        tf.math.reduce_sum_26[0][0]      
__________________________________________________________________________________________________
conv2d_173 (Conv2D)             (None, 1, 43, 24)    5208        tf.math.reduce_sum_27[0][0]      
__________________________________________________________________________________________________
reshape_12 (Reshape)            (None, 1, 1, 24)     0           conv1d_13[0][0]                  
__________________________________________________________________________________________________
concatenate_45 (Concatenate)    (None, 1, 93, 24)    0           conv2d_172[0][0]                 
                                                                 conv2d_173[0][0]                 
                                                                 reshape_12[0][0]                 
__________________________________________________________________________________________________
flatten_12 (Flatten)            (None, 2232)         0           concatenate_45[0][0]             
__________________________________________________________________________________________________
dense_24 (Dense)                (None, 48)           107184      flatten_12[0][0]                 
__________________________________________________________________________________________________
dropout_12 (Dropout)            (None, 48)           0           dense_24[0][0]                   
__________________________________________________________________________________________________
dense_25 (Dense)                (None, 1358)         66542       dropout_12[0][0]                 
==================================================================================================
Total params: 190,088
Trainable params: 190,088
Non-trainable params: 0
__________________________________________________________________________________________________
None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">)</span>
<span class="n">fancy_model_redo</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">optimizer</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="s1">&#39;mae&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history_redo</span> <span class="o">=</span> <span class="n">fancy_model_redo</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dset_train</span><span class="p">,</span>
                                    <span class="n">validation_data</span><span class="o">=</span><span class="n">dset_val</span><span class="p">,</span>
                                    <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/50
4857/4857 [==============================] - 47s 9ms/step - loss: 51.8521 - mse: 51.7794 - mae: 5.4774 - val_loss: 34.7588 - val_mse: 34.6951 - val_mae: 4.4938
Epoch 2/50
4857/4857 [==============================] - 46s 10ms/step - loss: 34.5634 - mse: 34.5022 - mae: 4.4999 - val_loss: 29.3127 - val_mse: 29.2526 - val_mae: 4.1374
Epoch 3/50
4857/4857 [==============================] - 47s 10ms/step - loss: 30.0238 - mse: 29.9642 - mae: 4.1915 - val_loss: 26.1518 - val_mse: 26.0927 - val_mae: 3.9143
Epoch 4/50
4857/4857 [==============================] - 47s 10ms/step - loss: 27.8155 - mse: 27.7567 - mae: 4.0374 - val_loss: 24.8086 - val_mse: 24.7500 - val_mae: 3.8071
Epoch 5/50
4857/4857 [==============================] - 47s 10ms/step - loss: 26.6074 - mse: 26.5485 - mae: 3.9509 - val_loss: 24.0527 - val_mse: 23.9936 - val_mae: 3.7634
Epoch 6/50
4857/4857 [==============================] - 47s 10ms/step - loss: 25.9619 - mse: 25.9025 - mae: 3.9018 - val_loss: 23.3402 - val_mse: 23.2806 - val_mae: 3.6985
Epoch 7/50
4857/4857 [==============================] - 47s 10ms/step - loss: 25.3735 - mse: 25.3136 - mae: 3.8610 - val_loss: 22.8819 - val_mse: 22.8219 - val_mae: 3.6720
Epoch 8/50
4857/4857 [==============================] - 47s 10ms/step - loss: 24.9963 - mse: 24.9360 - mae: 3.8321 - val_loss: 22.5815 - val_mse: 22.5211 - val_mae: 3.6476
Epoch 9/50
4857/4857 [==============================] - 47s 10ms/step - loss: 24.7633 - mse: 24.7027 - mae: 3.8153 - val_loss: 22.3132 - val_mse: 22.2525 - val_mae: 3.6270
Epoch 10/50
4857/4857 [==============================] - 47s 10ms/step - loss: 24.4529 - mse: 24.3920 - mae: 3.7931 - val_loss: 22.1945 - val_mse: 22.1335 - val_mae: 3.6268
Epoch 11/50
4857/4857 [==============================] - 47s 10ms/step - loss: 24.2113 - mse: 24.1502 - mae: 3.7740 - val_loss: 21.9083 - val_mse: 21.8471 - val_mae: 3.6004
Epoch 12/50
4857/4857 [==============================] - 47s 10ms/step - loss: 24.0850 - mse: 24.0237 - mae: 3.7634 - val_loss: 21.7548 - val_mse: 21.6933 - val_mae: 3.5879
Epoch 13/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.9708 - mse: 23.9093 - mae: 3.7560 - val_loss: 21.5587 - val_mse: 21.4970 - val_mae: 3.5732
Epoch 14/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.7519 - mse: 23.6902 - mae: 3.7398 - val_loss: 21.5169 - val_mse: 21.4550 - val_mae: 3.5695
Epoch 15/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.6779 - mse: 23.6159 - mae: 3.7336 - val_loss: 21.4082 - val_mse: 21.3461 - val_mae: 3.5659
Epoch 16/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.6003 - mse: 23.5381 - mae: 3.7273 - val_loss: 21.2439 - val_mse: 21.1817 - val_mae: 3.5492
Epoch 17/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.4598 - mse: 23.3976 - mae: 3.7164 - val_loss: 21.1660 - val_mse: 21.1036 - val_mae: 3.5434
Epoch 18/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.3972 - mse: 23.3348 - mae: 3.7111 - val_loss: 21.0770 - val_mse: 21.0145 - val_mae: 3.5335
Epoch 19/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.2762 - mse: 23.2136 - mae: 3.7020 - val_loss: 20.9751 - val_mse: 20.9124 - val_mae: 3.5304
Epoch 20/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.1640 - mse: 23.1012 - mae: 3.6940 - val_loss: 20.8962 - val_mse: 20.8333 - val_mae: 3.5248
Epoch 21/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.1129 - mse: 23.0500 - mae: 3.6908 - val_loss: 20.8484 - val_mse: 20.7854 - val_mae: 3.5203
Epoch 22/50
4857/4857 [==============================] - 47s 10ms/step - loss: 23.0318 - mse: 22.9688 - mae: 3.6824 - val_loss: 20.8367 - val_mse: 20.7735 - val_mae: 3.5166
Epoch 23/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.9709 - mse: 22.9076 - mae: 3.6783 - val_loss: 20.6311 - val_mse: 20.5678 - val_mae: 3.4987
Epoch 24/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.9156 - mse: 22.8521 - mae: 3.6742 - val_loss: 20.7734 - val_mse: 20.7098 - val_mae: 3.5183
Epoch 25/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.8497 - mse: 22.7860 - mae: 3.6674 - val_loss: 20.6596 - val_mse: 20.5959 - val_mae: 3.5061
Epoch 26/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.7788 - mse: 22.7150 - mae: 3.6626 - val_loss: 20.5426 - val_mse: 20.4788 - val_mae: 3.4970
Epoch 27/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.7056 - mse: 22.6416 - mae: 3.6564 - val_loss: 20.4238 - val_mse: 20.3597 - val_mae: 3.4873
Epoch 28/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.6437 - mse: 22.5795 - mae: 3.6530 - val_loss: 20.4533 - val_mse: 20.3891 - val_mae: 3.4877
Epoch 29/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.5945 - mse: 22.5302 - mae: 3.6472 - val_loss: 20.4830 - val_mse: 20.4186 - val_mae: 3.4929
Epoch 30/50
4857/4857 [==============================] - 47s 10ms/step - loss: 22.5696 - mse: 22.5051 - mae: 3.6454 - val_loss: 20.3024 - val_mse: 20.2379 - val_mae: 3.4746
Epoch 31/50
4857/4857 [==============================] - 48s 10ms/step - loss: 22.4788 - mse: 22.4141 - mae: 3.6386 - val_loss: 20.3969 - val_mse: 20.3321 - val_mae: 3.4859
Epoch 32/50
4857/4857 [==============================] - 48s 10ms/step - loss: 22.4530 - mse: 22.3882 - mae: 3.6374 - val_loss: 20.2411 - val_mse: 20.1762 - val_mae: 3.4708
Epoch 33/50
4857/4857 [==============================] - 46s 9ms/step - loss: 22.3680 - mse: 22.3031 - mae: 3.6308 - val_loss: 20.2916 - val_mse: 20.2265 - val_mae: 3.4769
Epoch 34/50
4857/4857 [==============================] - 42s 9ms/step - loss: 22.3646 - mse: 22.2995 - mae: 3.6294 - val_loss: 20.2547 - val_mse: 20.1895 - val_mae: 3.4760
Epoch 35/50
4857/4857 [==============================] - 41s 8ms/step - loss: 22.3009 - mse: 22.2356 - mae: 3.6241 - val_loss: 20.1045 - val_mse: 20.0391 - val_mae: 3.4612
Epoch 36/50
4857/4857 [==============================] - 41s 8ms/step - loss: 22.2943 - mse: 22.2288 - mae: 3.6231 - val_loss: 20.0468 - val_mse: 19.9813 - val_mae: 3.4549
Epoch 37/50
4857/4857 [==============================] - 53s 11ms/step - loss: 22.2005 - mse: 22.1349 - mae: 3.6183 - val_loss: 20.2443 - val_mse: 20.1786 - val_mae: 3.4740
Epoch 38/50
4857/4857 [==============================] - 40s 8ms/step - loss: 22.1421 - mse: 22.0764 - mae: 3.6124 - val_loss: 20.0422 - val_mse: 19.9763 - val_mae: 3.4552
Epoch 39/50
4857/4857 [==============================] - 40s 8ms/step - loss: 22.1555 - mse: 22.0896 - mae: 3.6129 - val_loss: 20.2784 - val_mse: 20.2124 - val_mae: 3.4839
Epoch 40/50
4857/4857 [==============================] - 43s 9ms/step - loss: 22.0902 - mse: 22.0242 - mae: 3.6076 - val_loss: 19.9330 - val_mse: 19.8668 - val_mae: 3.4452
Epoch 41/50
4857/4857 [==============================] - 43s 9ms/step - loss: 22.0578 - mse: 21.9915 - mae: 3.6057 - val_loss: 19.9882 - val_mse: 19.9219 - val_mae: 3.4536
Epoch 42/50
4857/4857 [==============================] - 43s 9ms/step - loss: 22.0022 - mse: 21.9358 - mae: 3.6025 - val_loss: 19.9296 - val_mse: 19.8632 - val_mae: 3.4482
Epoch 43/50
4857/4857 [==============================] - 40s 8ms/step - loss: 21.9859 - mse: 21.9193 - mae: 3.6000 - val_loss: 19.8790 - val_mse: 19.8124 - val_mae: 3.4447
Epoch 44/50
4857/4857 [==============================] - 40s 8ms/step - loss: 21.9586 - mse: 21.8918 - mae: 3.5981 - val_loss: 19.8321 - val_mse: 19.7653 - val_mae: 3.4398
Epoch 45/50
4857/4857 [==============================] - 40s 8ms/step - loss: 21.8942 - mse: 21.8273 - mae: 3.5918 - val_loss: 19.8176 - val_mse: 19.7506 - val_mae: 3.4389
Epoch 46/50
4857/4857 [==============================] - 40s 8ms/step - loss: 21.8466 - mse: 21.7796 - mae: 3.5879 - val_loss: 19.8665 - val_mse: 19.7994 - val_mae: 3.4434
Epoch 47/50
4857/4857 [==============================] - 40s 8ms/step - loss: 21.8024 - mse: 21.7352 - mae: 3.5861 - val_loss: 19.7607 - val_mse: 19.6934 - val_mae: 3.4318
Epoch 48/50
4857/4857 [==============================] - 41s 8ms/step - loss: 21.7714 - mse: 21.7038 - mae: 3.5835 - val_loss: 19.7766 - val_mse: 19.7091 - val_mae: 3.4371
Epoch 49/50
4857/4857 [==============================] - 45s 9ms/step - loss: 21.7473 - mse: 21.6798 - mae: 3.5808 - val_loss: 19.8007 - val_mse: 19.7331 - val_mae: 3.4381
Epoch 50/50
4857/4857 [==============================] - 48s 10ms/step - loss: 21.7941 - mse: 21.7264 - mae: 3.5857 - val_loss: 19.7528 - val_mse: 19.6850 - val_mae: 3.4330
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "javitausia/geocean-nz-ss",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-.conda-seb_ss-py"
        },
        kernelOptions: {
            kernelName: "conda-env-.conda-seb_ss-py",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-.conda-seb_ss-py'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Javier Tausía Hoyal<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>